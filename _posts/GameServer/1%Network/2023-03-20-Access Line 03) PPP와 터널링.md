---
title: Access Line 03) PPP와 터널링
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. PPP**

패킷은 ADSL, FTTH 등의 엑세스 회선을 타고 BAS에 도착한다. 액세스 회선은 원래대로면 라우터에 연결되어야 하는데 이 BAS가 라우터가 진화한 것이라고도 볼 수 있다. BAS는 본인 확인과 설정값 통지 기능을 갖는다. ADSL, FTTH는 최초에 이름과 패스워드를 입력하여 로그인하지 않으면 인터넷에 엑세스 할 수 없는데, 이때 BAS가 로그인 동작의 창구 역할을 하며 이를 위해 PPPoE 구조를 사용한다. 

PPPoE는 PPP 구조를 발전시킨 것이며, PPP는 전화 회선이나 ISDN을 사용하여 인터넷에 다이얼업 방식으로 접속할 때 동작하는 구조로 다음과 같이 동작한다. 먼저 프로바이더의 액세스 포인트에 전화를 걸고, 이름과 패스워드로 로그인을 한다. 이 정보는 RADIUS 프로토콜로 확인용 서버에 전송된다. 옳은 정보로 확인될 경우 IP 주소 등의 설정 정보가 반송되고 사용자는 이에 따라 IP 주소를 설정, 패킷 송수신 준비를 완료한다. 

이 동작의 요점은 TCP/IP 설정 정보 통지에 있다. 인터넷에 접속할 때는 PC에 글로벌 주소를 설정해야 하는데 다이얼업 접속을 이용하면 전화 번호에 따라 엑세스 포인트를 전환할 수 있으며, 전환한 포인트에 따라 주소가 달라지므로 PC 주소를 사전에 고정하지 않아도 되는 것이다. 대신 인터넷에서 PC에 TCP/IP 설정 정보를 통지해주고, 그 중에 포함된 글로벌 주소를 PC에 설정하면 된다. 

<br/>

# **2. PPPoE**

ADSL, FTTH도 PC에 글로벌 주소를 설정하지 않으면 인터넷에 접속할 수 없겠지만, 대신 이들은 케이블을 통해 BAS에 고정적으로 접속하므로 반드시 PPP 구조가 필요하진 않다. 그러나 이름, 패스워드 입력 동작을 남겨두면 이름에 따라 프로바이더를 전환할 수 있어 편리하기 때문에 ADSL, FTTH에도 여전히 위에서 설명한 PPP와 유사한 구조를 사용하고 있다. 

단, PPP를 그대로 사용하지는 못하는데 PPP 메시지를 운반할 때는 IP 패킷을 이더넷 패킷에 넣어 운반하는 것 같은 개념이 필요하기 때문이다. PPP 프로토콜은 이더넷의 프리앰블이나 FCS에 해당하는 규정이 없으므로 신호로 변환하여 송신할 수 없다. 따라서 PPP를 이더넷 패킷에 맞는 형태로 변형하고, 이를 PPPoE, PPP over Ethrenet이라고 부르며 사용하게 되었다. 


<br/>

# **3. 터널링**

BAS는 본인 확인 기능과 함께 터널링을 이용한 패킷 운반 기능을 갖는다. 터널은 TCP 커넥션으로 소켓과 소켓 사이를 연결한 것처럼, 한쪽 터널링 입구에서 패킷을 넣으면 그대로 출구에 도착하도록 만든 일종의 통로이다. 터널을 BAS와 프로바이더 라우터 사이에, ADSL/FTTH 접속 서비스 사업자의 네트워크 안에  만들고 이에 사용자-BAS 회선을 연결했다. 이를 통해 사용자로부터 프로바이더 라우터까지 한 개의 길을 통해 패킷이 인터넷 내부로 들어갈 수 있게 되었으며, 이는 액세스 회선이 프로바이더 라우터까지 연장되는 것과도 같다. 

터널링 실현 방식에는 TCP 커넥션을 사용한 방법과 캡슐화를 사용한 방법이 있다. TCP 커넥션을 사용할 경우 터널링용 라우터 사이에 TCP 커넥션을 만들고 소켓에 해당하는 부분을 라우터의 포트로 간주하여 터널링 규칙에 따라 패킷을 송신할 수 있을 것이다. 캡슐화를 사용할 경우 헤더를 포함한 패킷 전체를 별도의 패킷 안에 저장하여 출구까지 운반할 것이다. 이것도 패킷은 그대로의 모습으로 도착하게 된다. 이 외에도 패킷을 그대로의 모습으로 운반할 수 있다면 원리적으로는 어떤 것에도 터널링을 이용할 수 있다. 

<br/>

# **4. 액세스 회선 전체 동작**

액세스 회선 동작은 인터넷 접속용 라우터를 설치하고 인터넷에 접속하는 순간부터 시작된다. 먼저 라우터에 프로바이더가 할당한 이름과 패스워드를 등록하면 라우터가 PPPoE의 Doiscovery 구조에 따라 브로드캐스트를 이용해 BAS를 찾는다. 그럼 BAS가 MAC 주소를 응답으로 알려주고 BAS와 대화할 수 있게 된다. 이름과 패스워드를 보낼 때 패스워드를 암호화하는 CHAP 방식과 암호화 하지 않는 PAP 방식이 있는데 보통 CHAP을 권장하긴 하지만, PAP도 라우터-ADSL 모뎀 사이나 케이블을 도청하지 않는 이상 도청될 일은 없다. 

BAS에서 TCP/IP 설정 정보를 통지할 때 기기에 할당한 IP 주소, DNS 서버 IP 주소, 기본 게이트웨이 IP 주소를 통지한다. 인터넷 접속용 라우터를 사용할 경우 이 정보를 인터넷 접속용 라우터가 받아서 라우터 자체에 설정한다. 이렇게 인터넷 접속용 라우터의 BAS 측 포트에 글로벌 주소가 할당되고 경로표에 기본 게이트웨이가 설정되며 패킷을 인터넷에 중계할 수 있게 된다. 인터넷 액세스 패킷이 올 경우 게이트웨이에 패킷을 중계하고 PPPoE 규칙에 따라 패킷이 송신된다. 

PPPoE 규칙은 송신 패킷에 MAC/PPPoE/PPP 헤더를 붙인다. MAC 헤더는 수신처에 PPPoE Discovery에서 조사한 BAS MAC 주소를, 송신처에 인터넷 접속용 라우터의 BAS측 포트 MAC 주소를, 이더 타입에 PPPoE를 나타내는 0x8864를 기록한다. PPPoE, PPP 헤더는 페이로드 길이 외에는 사전에 값이 정해져 있으므로 이 값을 조사, 판단하는 일은 잘 없다. 이후 패킷을 신호로 변환하여 포트에서 송신하고, 패킷을 받은 BAS는 MAC, PPPoE 헤더를 제거, PPP 헤더 이후를 추출, 터널링 원리로 패킷을 프로바이더 라우터에 송신한다.

<br/>

# **5. Unnumbered와 프라이빗 주소 변환**

PPPoE, PPP 헤더의 값은 사전에 대부분 결정되어 있어서 경로표 기본 게이트웨이 항목에 어떤 값이 들어와도 관계가 없다. 라우터의 포트끼리 하나의 케이블로 연결된 상태에서는 중계 대상의 주소를 조사할 필요도, 경로표에 값을 기록할 필요, 라우터 포트에 IP 주소를 할당할 필요도 없기 때문이다. 과거엔 이런 상황에도 IP 주소를 할당하기도 했으나 현재는 할당하지 않는 것이 통례가 되었고 이를 Unnumbered라고 부른다. 이 경우 BAS에서 설정 정보를 통지하므로 기본 게이트웨이 IP 주소는 통지하지 않는다. 

BAS가 통지한 설정 정보를 PC에 설정하면 글로벌 주소가 할당되어 주소 변환을 사용하지 않고도 인터넷에 액세스 할 수 있다. 그러나 인터넷 접속용 라우터를 사용하면 글로벌 주소가 라우터에 할당된다. 이 경우 PC에는 프라이빗 주소를 할당한 후 PC가 보낸 패킷은 인터넷 접속용 라우터에서 주소를 변환한 후 인터넷에 중계한다. 웹이나 앱은 상관 없지만 애플리케이션 종류에 따라 주소 변환의 구조가 통지 동작을 지원하지 않는 경우, 주소를 변환하면 정상 작동하지 않는 경우도 있으므로 주의해야 한다. 

이러한 경우에는 라우터를 사용하지 않고 PPPoE 메시지를 PC가 받도록 연결하는 본래의 방법을 선택하면 된다. 그러나 글로벌 주소를 할당한 PC에는 인터넷에서 직접 패킷이 도착하므로 공격의 가능성이 있다. 따라서 클라이언트 PC용 방화벽을 사용하는 등 적절한 방어책을 세우는 것이 좋다. 

<br/>

# **6. PPPoE 이외의 방식**

PPPoA, PPP over ATM 방식은 PPP 메시지를 주고 받다는 점에서는 PPPoE와 동일하지만 PPP를 이더넷 패킷에 저장하는 대신 PPP를 그대로 셀에 저장하며 MAC 헤더, PPPoE 헤더도 붙이지 않는다. PPPoA는 맨 앞에 MAC 헤더가 없으므로 그대로 이더넷에 전송할 수 있으며, 이를 위해 PC나 라우터를 ADSL 모뎀과 일체화하는 방법이 추가된다. PPPoE와 달리 PPPoA에는 헤더가 부가되지 않으므로 MTU가 짧아지지 않고 효율성도 떨어지지 않는다. 

일체화에는 두가지 방법이 있는데 첫째는 PC의 USB 인터페이스에 ADSL 모뎀을 연결하는 것인데 이는 보급되지 않았다. 둘째는 라우터 일체형 ADSL 모뎀을 사용하는 것으로, 다른 경우에는 PPPoE에서 라우터를 사용하는 것과 차이가 없었기 때문에 널리 보급되었다. 그러나 라우터를 사용하지 않고 PC를 인터넷에 연결하는 대책은 마련하지 않았으므로 PPPoE와 마찬가지로 주소 변환에서 문제가 생길 수 있다. 또 ADSL 모뎀과 라우터를 분리할 수 없다는 제약이 생긴다

이러한 제약 때문에 PPP 대신 DHCP 구조를 사용하여 TCP/IP 설정 정보를 통지하기도 한다. 이는 주로 사내 LAN에서 많이 사용되며, DHCP 서버로 설정 정보만 통지하고 이름, 패스워드를 확인하지 않는다. 이름에 따라 프로바이더를 전환할 수는 없지만, 단순히 인터넷 패킷을 주고받기만 하기 때문에 MTU가 짧아지지 않는다는 장점이 있다. 또 이를 채택한 사업자는 셀을 사용하지 않고 패킷 그대로 ADSL 신호로 변환한다. 