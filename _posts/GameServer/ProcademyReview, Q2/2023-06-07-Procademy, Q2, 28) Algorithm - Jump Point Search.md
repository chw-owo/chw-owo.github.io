---
title: Procademy, Q2, 28) Algorithm - Jump Point Search
categories: ProcademyReview
tags: 
toc: true
toc_sticky: true
---

이 포스트는 프로카데미 (게임 서버 아카데미) 수업을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. Node 생성**

현실에서 길을 찾을 때는 새로운 길이 나올 때 어디로 가야할지 새로 판단을 한다. 마찬가지로 Jump Point Search에서도 새로운 길이 나타날 때마다 노드를 만들고 다시 판단을 내린다. AStar 알고리즘에서는 현 노드를 중심으로 8방향에 매번 새 노드를 생성했다면, Jump Point Search 에서는 새로운 길이 나타날 때만 노드를 생성한다. 그 외의 탐색은 동일하게 진행하되, 노드 생성 및 OpenList의 삽입과 정렬 시간을 줄임으로서 성능을 향상시키는 것이다. 이미 노드가 있다면 만들지 않는 것, 노드를 기준으로 8방향 검사해서 나아갈 방향을 결정하는 것 등은 기존 Astar와 동일하다.

여기서 새로운 길은 타일이 막혔다가 뚫리게 된 상황으로 정의한다. 잘 가다가 길이 막히는 것은 오히려 판단의 대상이 아니다. 그냥 갈 수 없는 길이니 안가면 된다. ( x-1, y ) = OBSTACLE, ( x-1, y-1 ) = NONE 이 체크를 현 위치부터 바라보는 방향의 끝까지 모든 좌표에서 하는 것이다. 목적지도 노드 생성 상황에서는 장애물과 동일하게 취급한다. 따라서 노드 생성에 의한 성능 저하는 감소하지만, 대신 구역 체크에 의한 성능 저하가 발생한다. 즉, Astar는 광활하게 뻥뻥 뚫린 맵이어도 직선 이동을 한다면 성능 저하가 크지 않은 반면 JPS는 맵이 클 수록 성능 저하가 커진다. 실제 게임에서는 넓은 맵을 쓸 경우 성능을 위해 범위를 정해서 일정 범위 내까지만 체크를 한다. 

AStar의 경우 노드 생성도 생성이지만 OpenList에 대한 삽입 정렬이 속도를 많이 떨어뜨리는 요인이 되는데, JSP는 노드 자체가 적기 때문에 그 과정이 단축되면서 성능이 좋아진다. 대신 속성 체크가 워낙 잦다보니 함수 호출만으로도 많이 느려질 수 있으므로 매크로 혹은 인라인 처리로 빠르게 가야한다. 

<br/>

# **2. 방향 별 코너 탐색**

노드는 방향을 바탕으로 코너를 체크해야 하므로 방향 값을 들고 있어야 한다. 부모 좌표와 내 좌표를 빼서 방향을 구해도 되고, 자식 노드 생성 시 방향값을 갖도록 만들어도 무관하다. 이때 왼쪽에 코너가 있어서 만든 것인지 오른쪽에 코너가 있어서 만든 것인지도 체크를 해서 해당 자식 노드 중심으로 탐색을 할 때 참고해야 한다. 만약 좌우 모두에 코너가 있었다면 앞, 왼, 오 세 방향을 모두 탐색해야 할 것이다. 시작 노드는 부모도 없고 방향도 없으므로 8방향을 전부 탐색해야 한다. 이때, JSP는 중복으로 체크하는 구간이 생길 수 있다. 중복으로 노드를 생성하진 않지만 구간 체크는 이미 했더라도 또 해야 한다. 방향이 달라지면 코너도 달라질 수 있기 때문이다. 

수직 수평은 한 방향만 바라보고 그 길 안에서 코너가 있는지만 체크하면 된다. 이때 노드는 코너 진입부 대신 코너 진입 직전에 생성한다. 코너 진입부에 노드를 만들 경우 수직, 수평 체크 구역과 대각선 체크 구역이 겹쳐서 이중으로 체크를 하게 되기 때문이다. 반면 대각선은 대각선 방향의 코너 뿐 아니라, 대각선으로 한칸씩 이동하면서 수직, 수평으로 코너 체크를 해주어야 한다. 그리고 그걸 체크하기 위해 대각선 방향에 노드를 만들고, 만약 그 대각선 노드가 탐색 노드로 선택이 되었다면 그 노드를 타고 가서 그 노드의 원인이 된 위치에 새 노드를 만들 것이다. 지형에 따라서 노드 한번 만들 때마다 맵 전체를 탐색하게 될 수도 있다. 

속성 체크를 더 빠르게 하기 위해 죄다 막혔는지, 죄다 뚫렸는지, 중간에 뚫렸는지 한번에 체크할 수 있도록 속성을 비트로 만들 수도 있다. 64bit 변수를 쓴다면 64개씩 한번에 체크할 수 있기 때문에 속도가 빨라진다. 이 경우 미리 비트 단위로 짜여진 맵 데이터가 존재해야 하며, 뻥 뚫린 길 혹은 꽉 막힌 길에서는 효과가 있지만 듬성 듬성 뚫려있을 땐 큰 효과를 보기 어렵다. 

