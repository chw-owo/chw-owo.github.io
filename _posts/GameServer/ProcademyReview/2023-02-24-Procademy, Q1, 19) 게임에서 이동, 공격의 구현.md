---
title: Procademy, Q1, 19) 게임에서 이동, 공격의 구현
categories: ProcademyReview
tags: 
toc: true
toc_sticky: true
---

이 포스트는 프로카데미 (게임 서버 아카데미) 수업을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 이동의 구현**

## **1) 마우스 클릭 조작**

마우스 클릭을 통한 이동을 구현하는 가장 정석적인 방법은 클라에서 클릭했다는 정보를 서버에 전송한 뒤, 서버에서 가야할 경로를 길찾기로 처리하고 그 경로를 각 클라에 뿌리는 것이다. 그러면 모든 클라에서 동일한 경로 정보가 반영되어 동일하게 이동하는 것으로 보이게 된다. 이 방법의 단점은 첫째로 서버에서 길찾기를 매번 받아서 처리하는 것이 서버에 부담이 될 수 있다. 둘째로 결과 좌표가 아니라 경로(=연속된 좌표)를 클라에게 보내야 하므로 네트워크 부하로 이어질 수 있다. 

두번째 방법은 클라와 서버에 동일한 길찾기 로직을 심어둔 뒤, 결과 좌표만 보내는 것이다. 동일한 목적지, 동일한 장애물, 동일한 로직을 사용한다면 동일하게 동작할 것이기 때문에 이 방법도 문제가 되지 않는다. 그러나 동적으로 변하는 장애물이 있어서 서버에 보낸 시점과 클라에서 이동하는 시점에 환경이 변한다면 결과도 변할 것이다. 이러한 이유로 캐릭터끼리 이동 중에 충돌이 되는 MMORPG는 없다. 일반적으로 길막기 기능도 정지 중인 캐릭터에 한해서만 적용하는 경우가 많다. 물론 롤과 같은 전략 시뮬레이션의 경우 MMORPG와는 구현 방식이 아예 달라져야 된다.

세번째 방법은 서버에 길찾기 로직을 넣는 것 자체가 부담이 되므로 아예 클라에서 길찾기를 처리해버리는 것이다. 클라에서 길찾기를 처리하여 그 경로를 서버에 던지면 서버에서는 경로를 검증하여 결과를 뿌려준다. 또, 클라에서 길찾기로 찾은 경로를 근거리 단위로 나누어 짧은 길이의 경로 좌표를 서버에게 보내는 방법도 있다. 유니티 길찾기 로직을 사용한 클라를 서버에 연동해야 된다거나 하는 경우에 이러한 방법을 사용할 수 있다.

이 중 어떤 방식을 선택할지에 대한 건 네트워크, 서버의 상황과 인력, 기간 등을 고려하여 결정된다.  


## **2) 키보드 조작**

첫번째로, 마우스 조작 때와 마찬가지로 서버에게 요청을 보내고 다시 응답을 받은 후 이동하는 방법이 있으나 이것은 너무 시간이 오래 걸려서 조작감이 떨어진다. 두번째로, 클라에서 알아서 이동을 먼저 한 뒤 서버에는 통보만 하고, 해당 정보를 서버에서 다른 클라에 보내는 방법이 있다. 하지만 이것 역시 다른 클라에서는 느리게 반영된다는 단점이 있다. 무엇보다도 정지했을 때 이동하다 말고 기존에 원래 멈췄던 자리로 돌아가야 하므로 덜그럭거리는 것처럼 보이게 된다. 이러한 상황을 예방하려면 현재 상태를 주는 게 아니라 목적지를 주어야 한다. 따라서 실제로는 이러한 상황을 기획적으로 해결한다. 방향키를 뗐을 때 바로 멈추는 대신 몇 걸음 더 이동하는 자리를 목적지로 지정하여 몇걸음 더 이동시키거나, 브레이크 이펙트를 넣는 등의 방법으로 자연스럽게 보이게 하는 것이다. 타일 단위로 맵이 이루어진 게임의 경우 타일 위치를 통해 동기화하는 방법을 사용하기도 한다. 

엄지손가락 혹은 wasd로 방향을 조절할 수 있어서 360도 회전이 가능한 맵의 경우 그 자유분방한 동선의 좌표를 전부 서버에 보낼 순 없다. 따라서 엄지손가락 혹은 wasd로 조절된 방향을 통해 플레이어가 목적지로 바라보는 더미 오브젝트를 생성하고, 해당 더미 오브젝트의 위치를 서버에 보내는 방식을 사용한다. 그리고 클라에서는 플레이어와 더미 오브젝트 사이의 보간처리(lerp)를 통해 거리가 멀어지면 빠르게 가고 가까워지면 느리게 가도록 처리하게 된다. 이 방법을 사용하면 네트워크 지연으로 인해 잠시 좌표가 틀어진 상황에서도 해당 상황을 유연하게 처리할 수 있게 된다. 이 경우에도 서버를 통해 검증하고 이동하는 것이 아니라 이동 후 통보하는 것이기 때문에, 네트워크가 끊기더라도 내 화면에서는 계속 이동할 것이다. 이를 막기 위해 서버와 통신이 단절이 되는 경우에는 이동 반경이 제한되게끔 설정을 하는 경우도 있다. 이 경우 서버로부터 응답이 없을 때 이동할 수 있는 반경은 제한되어있지만 그래도 응답 이전에 이동할 수는 있다. 클라에서 조작을 하면 먼저 움직인 뒤 서버에 통보하고, 응답이 오면 이동할 수 있는 반경도 함께 이동하게 된다. 

<br/>

# **2. 공격의 구현**

근거리 공격의 경우 공격한다는 요청을 보내면 서버에서 공격 가능한 반경인지, 데미지가 어느정도인지 판정한 후 응답을 보내고 응답을 받은 후에 공격 이펙트가 터진다. 클라에서 요청한 정보가 조작되었을 가능성을 고려하여 공격과 공격 사이에 쿨타임을 정해두거나, 연속된 공격이 몇차례 이상 들어왔을 때 밴하는 식으로 체크를 해야 하기 때문이다. 그러나 원거리 공격의 경우 발사 타이밍에 공격 이펙트가 터져야 한다. 따라서 공격하는 이펙트와 공격 받는 이펙트를 분리하여 공격한 클라 쪽에서 공격 이펙트를 터뜨리고 서버에서 판정한 뒤 결과를 클라에 뿌리며 동시에 공격 받는 이펙트를 터뜨린다. 공격하는 사람 외의 클라에서는 공격 받았다는 정보가 조금 느리게 도착하기 때문에 약간의 격차가 생긴다. 만약 그 요청 응답 과정 사이에 타겟의 위치가 바뀌었다면 공격자 외의 클라에서는 공격하는 사람의 각도를 수정하여 맞춘 것처럼 보이게 하는 방식으로 보완할 것이다. 클라마다 생기는 약간의 격차와 차이는 어쩔 수 없으며, 결과를 통일시키는 것과 그 격차를 사용자가 느끼지 못하도록 보완하는 것이 중요하다. 

총을 구현할 때 MMO 환경에서 우리 슈팅 게임처럼 좌표를 실시간으로 바꾸며 충돌처리를 할 수는 없다. 일반적으로는 출발지와 목적지를 정해두고 두 지점의 직선을 그어서 충돌하는 객체가 있는지 탐지하기 때문에 발사 순간에 결과가 결정된다. 배그와 같은 MO 규모에서는 실제 객체를 날려서 매 순간 충돌처리를 할 수도 있으나 MMO가 되면 이것이 어려워진다. 타겟팅이 되어서 날아가는 도중에 충돌처리 할 필요가 없다면 도착 지점만 계산하면 되기 때문에 서버에서 굳이 작업할 필요가 없지만, 논타겟팅이라 중간에 충돌 처리가 들어가게 되면 매 순간 위치를 계산해야 한다. 따라서 이 부분은 기획자와 협의를 통해 어떻게 구현해야 할지 결정해야 한다. 

액션성이 아주 중요한 게임의 경우, 서버로부터 응답이 오기 전에 반응을 하여 사용자가 타격감을 느낄 수 있도록 하는 것이 중요하다. 따라서 일반적으로 클라에서 서버로 데이터를 보내고 클라에서 먼저 충돌 처리를 해서 충돌 처리가 됐으면 타격 액션 직전까지 액션을 먼저 시킨다. 그 후 서버에서 응답이 돌아왔을 때 데미지가 들어갔으면 데미지 액션을, 안됐으면 튕겨내는 액션을 시킨다. 

<br/>

# **3. 네트워크 레이턴시**

국내의 네트워크 레이턴시는 2-3ms 정도로 모니터 주사하는 시간보다 짧은 시간이다. 플레이어들이 네트워크 레이턴시라 부르는 건 거의 서버, 클라 로직에서 생기는 레이턴시라고 볼 수 있다. 물론 해외로 수출하는 게임이 되면 물리적으로 네트워크 레이턴시가 생긴다. 그래서 소수 인원이면 모를까 MMORPG를 다른 나라끼리 함께 하는 것은, 현재 네트워크 환경에서는 레이턴시가 체감될 수 밖에 없다. 게다가 국제회선은 국내 회선에 비해 가격도 10배 가까이 높기 때문에 네트워크 자체에서 오는 레이턴시가 생긴다. 그래도 요즘은 해저케이블 덕분에 대륙별 서버 정도는 만들 수 있을 만큼 빨라지고 있다. 리니지 W가 MMORPG면서도 대륙별 서버를 만든 대표적인 사례.

<br/>

# **4. 질의응답**

Q. 게임을 하다가 렉 걸렸는데 막 움직이면 움직이고, 그러다가 다시 원위치로 돌아오는 상황이 가끔 있었는데 그런 현상은 왜 생기나요?

A. 클라의 조작감을 위해 일단 움직이지만 서버에서 검증이 안됐으니 반영은 안되는 그런 상황이라고 해석할 수 있습니다. 