---
title: 웹 서버 2) 서버의 수신 동작
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. IP 담당 부분**

서버가 패킷을 수신하는 동작은 클라이언트와 동일하다. 다시 정리하고 넘어가자면, 우선 LAN 어댑터에서 수신한 신호를 프리앰블과 SFD를 바탕으로 데이터로 전환하고, FCS로 오류를 검출한다. 이후 수신처 MAC 주소를 조사하여 자신과 일치할 경우 패킷을 수신, CPU에 인터럽트로 패킷의 도착을 알린다. 이후 TCP/IP의 프로토콜 스택을 호춣하여 여기에 패킷을 건네주게 된다.

프로토콜 스택에 패킷이 전달되면 IP 담당 부분이 IP 헤더를 점검한다. IP 헤더가 올바르고 수신처 IP 주소가 자신과 동일할 경우 수신한다. 라우터와 같이 패킷 중계 기능이 유효한 경우 자신을 대상으로 하지 않는 패킷도 도착하는데, 그 경우 경로표를 조사하여 다시 중계한다. 이후엔 분할된 패킷인지 확인하고 분할된 경우 메모리에 저장해두었다가 리어셈블한다. 이후 프로토콜 번호 항목에 따라 해당 담당 부분에 패킷을 건넨다. 

<br/>

# **2. TCP 담당 부분**

TCP 담당 부분의 연결 끊기 동작의 경우 클라이언트 측과 동일하게 동작하나, 데이터를 송수신하는 동작은 패킷의 내용에 따라 달라진다.

SYN가 1인 접속 동작 패킷이 오면 수신처 포트 번호를 조사하여 이미 같은 번호를 할당한 대기 소켓이 있는지 확인한다. 없으면 오류를 통지하고, 있다면 패킷을 복사하여 새 소켓을 만든 후 제어 정보를 기록, 송수신 버퍼 메모리를 확보한다. 이후 ACK 번호, 시퀀스 번호 등을 기록한 TCP 헤더를 만들고 반송한다. 클라는 이 패킷을 받으면 ACK 번호를 반송하며 이로써 접속 동작이 완료된다. 이때 서버측은 accept 호출 후 실행을 정지한 상태인데 여기에 새로 만든 소켓의 디스크립터를 전달하여 서버측의 동작을 재개한다. 

데이터 송수신 단계에서 데이터 패킷이 도착한 경우, TCP 담당 부분이 해당 패킷이 어느 소켓에 해당하는지 조사한다. 여기엔 송수신처의 IP 주소와 포트번호가 모두 필요하다. 소켓을 찾았다면 시퀀스 번호와 길이로부터 송수신이 올바르게 되고있는지 점검하고, 패킷에서 데이터를 추출해 수신 버퍼에 저장한다. 그리고 시퀀스 번호와 길이를 바탕으로 ACK 번호를 기록하여 TCP 헤더를 만들고 반송한다. 이후 애플리케이션이 read를 호출하면 데이터를 건네주며 제어가 애플리케이션으로 넘어간다. 
