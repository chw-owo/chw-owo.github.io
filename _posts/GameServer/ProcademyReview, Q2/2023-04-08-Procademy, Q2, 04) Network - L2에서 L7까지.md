---
title: Procademy, Q2, 04) Network - L2에서 L7까지
categories: ProcademyReview
tags: 
toc: true
toc_sticky: true
---

이 포스트는 프로카데미 (게임 서버 아카데미) 수업을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. L1: 모뎀**

아파트에 LAN 케이블이 튀어나온 경우 실제로 기기가 LAN 케이블을 통해 연결된 상태이며 별도의 변환이 필요 없다. 그러나 ADSL, FHHT 와 같이 이더넷 외의 통신 방식을 쓰는 케이블이 연결된 경우, 케이블 모뎀이 이더넷과 통신할 수 있는 프로토콜로 변경해주는 장치로써 쓰인다. 그러나 요즘 건물들은 인터넷을 설치하지 않아도 꽂으면 연결되는 곳이 대부분이기 때문에, 최근의 모뎀은 주로 인터넷 TV 연결 목적으로 사용된다. 

<br/>

# **2. L2: L2 스위치, MAC 주소 테이블**

프레임이 L1을 거쳐 랜선으로 나간 후 처음 만나는 장치는 L2 스위치일 확률이 높다. 2005년까지는 전체에 전송하는 더미 허브를 사용했으나, 최근에는 MAC 주소 테이블을 가진 L2 스위치가 보편화 되었다. L2 스위치는 MAC 주소를 바탕으로 중계하기 때문에 IP 주소는 확인하지 않는다. MAC 주소가 테이블에 없으면 브로드캐스트를 하는데, 이 경우에도 별도의 버퍼를 사용하기 때문에 충돌 문제가 생기지 않는다. 보통 포트에 다른 L2 스위치를 연결할 경우까지 고려하여 몇천개의 주소까지 등록할 수 있게끔 지원하며, 고가 스위치의 경우 모니터링용 포트를 함께 제공하기도 한다.

<br/>

# **3. L3: 라우터**

IP 헤더에는 TTL이 붙는데, 라우터를 경유할 때마다 이 값을 1씩 감소시키고 0이 되면 폐기한다. 길면 128, 짧으면 64로 설정하는데 이는 지구 반대편까지 가기에도 충분한 숫자다. 이를 통해 잘못된 패킷으로 인한 트래픽 증가를 예방한다.

모든 스위치는 받을 수 있는 최대 개수가 정해져있다. 따라서 뒤에 설명할 L4 스위치를 원활하게 사용하기 위해서는 도메인에서의 로드 밸런싱도 필요하다. 이는 보이는 도메인은 하나지만 그 안에서 여러개의 IP 주소로 분배하는 것을 의미한다. 도메인 별 분배의 경우 우선적으로 국가별 분배가 기본으로 이루어지고 있다. 이 때문에 실제로 우리나라에서 구글에 접속할 때와 외국에서 구글에 접속할 때 IP를 확인해보면 다른 값이 뜨는 것을 볼 수 있다. 

<br/>

# **4. L4: 로드 밸런서, L4 방화벽**


L4 스위치는 첫째로, 동일 IP로 전송된 패킷들이 여러 포트를 향하도록 자체적으로 분배할 수 있다. 그러나 이는 유용하게 쓰이는 기능은 아니다. 두번째로, 부하를 분산시키는 로드 밸런서 역할을 할 수 있다. 서버 여러대를 로드 밸런서에 연결하고, 사용자에게 로드 밸런서의 IP를 주면 '특정 IP, 특정 포트에서 들어온 패킷은 특정 서버와 연결한다’는 세션 유지 작업을 로드밸런서가 처리함으로써 부하를 적절히 분배해준다.

요청이 들어왔을 때 해당 요청의 IP, 포트 번호를 보고 메모리를 탐색하여 연결된 서버가 있는지 찾고, 없으면 적절한 새 서버를 배정한다. 경유하기 때문에 약간의 속도 저하는 생긴다. 외부에서는 L4 스위치의 주소만 보이므로 포트 번호는 하나만 지정해도 된다. L4와 연결된 서버들은 사설 IP를 따로 부여받는 별개의 기기들이며 그것들이 L4 스위치와 함께 묶여서 하나의 LAN이 된다. 방화벽을 쓸 경우 이 포트는 서버로 쓸 것이니 열어둔다고 따로 설정해야 한다. 

정교한 분배를 위해서는 포트 번호를 알아야 하기 때문에, L3 대신 IP와 port를 모두 확인할 수 있는 L4에서 이 작업을 수행한다. 예시로 HTTP는 TCP로 연결-전송-해제를 반복하는데 이때 연결에서만 3단계의 패킷 전송이 일어나며, 만약 데이터가 큰 경우 전송도 여러개의 패킷을 보내게 된다. L3에서는 동일 IP를 모두 동일 서버로 연결하지 않는 한 이 과정을 제대로 수행할 수 없다. 로드밸런싱 소프트웨어도 있지만, 그것 자체가 성능을 차지하므로 200%의 성능이 아닌 150%의 성능이 난다. 

또, 이러한 L4 스위치 앞단에는 물리적 방화벽을 함께 두는데, 이것도 L4 계층에 속한다. 방화벽은 IP를 갖는 것과 갖지 않는 것으로 나뉜다. IP를 갖지 않는 것은 그저 거쳐가는 기기로, IP/TCP 헤더를 분석하여 패킷을 필터링한다. IP를 갖는 것은 보통 NAT을 바탕으로 동작한다. 이 경우 내부의 서버들을 사설 IP로 가려 모든 공격이 방화벽으로 가도록 한다. 보통 렌탈 방화벽은 전자를 의미하며, 이게 하드웨어적으로 조금 더 빠르고 사용자가 커스텀 하기 쉽기 때문에 게임 업계에서는 이를 더 선호한다. 

<br/>

# **5. L7: L7 방화벽**

L5, L6는 장비가 없지만 L7 스위치는 있다. 이는 어플 계층의 패킷까지도 해석할 수 있다는 의미로, 대부분 방화벽을 의미한다. Web 방화벽의 경우 이는 HTTP 프로토콜을 분석하여 공격 패턴을 DB화고, 이를 바탕으로 메시지를 필터링한다. 혹은 URL에 따른 서버 분배 역할을 수행하기도 한다. 웹에서는 필수적으로 쓰이지만, 게임에서는 데이터 갈취 및 악용할만한 데이터가 오고가지 않는 관계로 잘 쓰이지 않는다.

<br/>

# **6. NAT**

192.168.0.2의 IP를 가진 컴퓨터로 1.1.1.1:80를 향해 메시지를 보낸다면 Src 192.168.0.2:5000, Dest: 1.1.1.1:80 가 적혀있는 패킷이 전송될 것이다. 그러나 이 IP는 LAN 안에서만 공유되는 주소로, 라우터를 빠져나가면 의미가 없어진다. 즉, 목적지가 내 주소를 알기 위해서는 내 공유기의 공인 IP를 바탕으로 확인해야 한다. 이를 위해 Gateway(공유기)에서는 Network Address Translation, NAT이 이루어진다. 

공유기가 211.10.7.100의 공인 IP를, 192.168.0.1의 사설 IP를 가진다고 가정해보자. 우선 Src에 있는 IP:port를 포워딩 하기 위해 Gateway(공유기)에 포트포워딩 테이블을 참조할 것이다. 공유기의 10000번 포트에 192.168.0.2:5000을 지정했다면 기존의 Src를 211.10.7.100:10000으로 바꾼다. 만약 이후에 외부에서 들어온 메시지의 Dest가 211.10.7.100:10000이라면 이를 192.168.0.2:5000으로 교체한 후 해당 LAN 안에서 전달할 것이다. 이러한 변환이 매번 시행된다. 

안에서 밖으로 나갈 때 포트포워딩 테이블이 동적으로 등록되며, 외부에선 등록되지 않는 서버에 접근할 수 없다. 내가 서버를 열 때는 수동으로 등록해주어야 한다. 테이블의 정보는 일정 개수를 넘었을 때, 연결 해제가 일어났을 때, 설정한 Timeout이 지났을 때 삭제되며, 이 때문에 갑자기 통신이 단절되기도 한다. 일반적인 L4 스위치와 L4 방화벽은 이 기능을 기본적으로 내장하고 있다. 이런 이유로 개인 컴퓨터를 공인 IP로 설정하면, Gateway가 막던 공격들이 다 그 컴퓨터로 갈 수 있다. 

공유기 관리자 페이지 - 고급설정 - NAT 관리 - 포트포워드 설정에서 정적으로 내 사설 IP를 등록할 수 있다. 이것도 특별한 경우가 아니면 공격 위험성이 높아지므로 하지 않는 게 좋다. 또, UPNP 프로토콜을 사용할 경우, 장치가 공유기에게 UPNP를 보내면 자동으로 포트포워딩을 실행 한다. IP 카메라, 토렌트 등이 이 프로토콜을 사용하며 이 경우 LAN에 연결만 해도 자동으로 등록이 된다. UPNP 규칙보기에서 이를 확인할 수 있으며 UPNP 설정에서 금지할 수 있다. 

공유기 스펙을 보면 128K, 즉 약 120000개의 커넥션을 지원하는 경우가 많다. 포트가 약 60000개가 최대이기 때문에 TCP, UDP를 합쳐 최대 120000개의 커넥션이 가능한 것이다. 만약 전부 TCP를 쓰고 있다면 약 60000개가 최대일 것이다. 이 값은 메모리 크기에 관계 없이 어떤 기기든 동일하다. 하지만 이 최대 연결 수에 상관 없이 패킷 개수가 많아지면 NAT 부담이 커지기 때문에 짧은 메시지를 여러개 보내는 경우 이 커넥션을 채우기도 전에 공유기가 터질 확률이 높다. 

위와 같은 원리로 내 컴퓨터를 공유기로 만들 수 있다. Starbucks로 이름 바꾸고 스타벅스 가서 내 컴퓨터를 공유기로 켜두면 사람들이 내 컴퓨터를 거쳐서 패킷을 주고 받을 것이며, 패킷 캡쳐 프로그램으로 패킷들의 프로토콜, 포트 등을 확인할 수 있다. 물론 https면 유의미한 정보를 얻을 순 없지만 전송 시간 및 간략한 정보로 대략적인 정보를 추정할 순 있으며 http 혹은 게임 데이터와 같이 복잡한 암호화를 하지 않는 데이터인 경우에는 패킷을 살펴볼 수 있다.

