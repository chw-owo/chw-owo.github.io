---
title: LAN 03) 라우터의 패킷 중계
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 라우터의 구조와 수신 동작**

리피터 허브, 스위칭 허브를 경유한 패킷은 라우터에 도착하여 다음 라우터로 중계된다. 내부의 표를 보고 중계한다는 점에서는 스위칭 허브와 유사하나 이더넷이 아닌 IP를 바탕으로 중계한다는 점에서 차이가 있다. 라우터는 중계 부분과 포트 부분으로 구성되어 있으며 중계 부분이 판단하는 일을, 포트 부분이 송수신 하는 일을 담당한다. 

이는 IP 담당 부분과 LAN 어댑터의 역할 분담과도 유사하다. 컴퓨터에서 LAN 어댑터를 교환하면 이더넷 뿐 아니라 무선 LAN도 지원하듯이, 라우터 포트 부분도 무선 LAN용 하드웨어를 장착할 수 있다. 컴퓨터용 LAN 어댑터가 거의 이더넷, 무선 LAN만을 지원하는 것과 달리, 라우터의 포트 부분은 ADSL, FTTH 등 광대역 회선, 전용선 통신 회선 등을 지원하기도 한다. 

라우터는 포트 부분에서 패킷을 수신하고, 수신처 IP 주소와 표를 대조하여 중계 대상을 판단한 뒤, 해당 포트로 패킷을 옮겨 송신한다. 이때 이더넷인지, LAN인지 등에 따라 해당 통신 기술 규칙에 맞춰서 송수신을 수행한다. 패킷을 전송만 하고 송수신처가 되지는 않는 스위칭 허브와 달리, 포트가 이더넷이라면 라우터의 포트에 MAC 주소가 할당되어 이더넷의 송수신처가 된다. 

라우터 포트는 여러가지가 될 수 있는데 여기서는 이더넷을 기준으로 설명한다. 이더넷 포트 부분의 구조는 PC LAN 어댑터와 거의 동일하다. 신호가 커넥터에 도착하면 PHY(MAU), MAC 회로를 거쳐 디지털 데이터로 변환하고 FCS로 오류를 체크한다. 정상일 경우 MAC 수신처 주소를 조사하여 일치할 때만 패킷을 수신 버퍼 메모리에 저장, 아닐 경우 폐기한다. 

<br/>

# **2. 라우팅 테이블, 경로표**

스위칭 허브는 MAC 주소로 중계 대상을 판단하는 반면 라우터는 IP 주소로 판단하기 때문에 테이블의 내용도 달라진다. 라우팅 테이블은 크게 수신처, 넷마스크, 게이트웨이, 인터페이스, 메트릭으로 이루어져있다. 그 중 수신처는 네트워크 번호 부분의 bit에만 값이 있고 호스트 번호 부분은 0으로 이루어진 IP 주소 값을 가지며, 넷마스크는 네트워크 번호의 bit 수를 나타낸다. 

이때 주소 집약 개념을 이용하여 몇개의 서브넷을 모아 한개의 서브넷으로 간주하여 경로표에 등록하기도 한다. 반대로 상황에 따라 한개의 서브넷을 세분화하여 등록하거나 개별 컴퓨터 주소를 수신처 항목에 등록하기도 한다. 이럴 경우 서브넷의 넷마스크 값과 경로표의 넷마스크 값이 다르게 나타지만 라우터는 동일하게 중계 동작을 수행한다.

게이터웨이와 인터페이스 항목은 패킷의 중계 대상을 나타낸다. 수신처 항목으로 해당하는 행을 찾아내면 그 행의 인터페이스에서 게이트웨이 항목에 등록된 IP 주소의 라우터에 대해 패킷을 중계한다. 마지막 메트릭은 목적지까지의 거리를 나타낸다. 

스위칭 허브는 패킷 중계 동작의 일환으로 MAC 테이블에 정보를 등록하지만 라우터는 중계 동작과 분리하여 경로표를 갱신한다. 즉, 중계 동작에서 경로표를 수정하지 않는다. 라우터의 경로표는 사람이 수동으로 경로 정보를 등록하거나 라우팅 프로토콜이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하는 방식으로 갱신된다. 

<br/>

# **3. 출력 포트 조사 방법**

라우터는 패킷 수신이 끝나면 MAC 헤더를 폐기한다. MAC 헤더는 이 라우터에 패킷을 건네주는 것이었기에 역할이 끝났으므로 폐기하는 것이다. 그리고 수신처 IP 주소와 경로표 수신처 항목을 조사하여 해당하는 행을 찾는다. 이 과정에서 복수의 행이 발견될 경우 일치하는 것 중 네트워크 번호 bit 수가 가장 긴 것을 중계 대상으로 삼는다. 만약 길이가 같은 것이 여러행이라면 라우터 고장 및 단선을 고려해 우회로를 둔 것으로, 이럴 땐 메트릭 값이 작은 쪽을 선택한다. 

만약 해당하는 행이 하나도 없을 경우 라우터는 패킷을 폐기하고 ICMP 메시지로 송신처에 사실을 통지한다. 스위칭 허브는 많아야 수천대 정도의 네트워크를 가정하기에 중계 대상이 없으면 모두에게 패킷을 뿌리지만, 라우터가 가정하는 네트워크는 전세계에 펼쳐져있기 때문에 스위칭 허브와 같은 방식으로 해결할 수 없다. 

위 상황을 대비해 모든 중계 대상을 등록하는 것은 불가능하고, 일반적으로는 넷마스크가 0.0.0.0으로 되어있는 기본 경로 행이 존재하여 일치하는 행이 없을 경우 이를 고르게 된다. 이는 모든 주소가 일치하는 값으로, 이 행의 게이트웨이에 인터넷으로 나가는 라우터를 등록해둔다. 이러한 방법으로 중계 대상이 분명하지 않은 사태를 방지한다.

<br/>

# **4. 패킷의 유효기한과 분할**

라우터는 송신 이전 IP 헤더의 TTL 필드를 갱신한다. TTL, Time To Live는 생존 기간을 의미하며 라우터를 경유할 때마다 값을 1씩 줄이다가 숫자가 0이 되면 폐기한다. 이는 패킷이 오류 및 기기 고장으로 인해 순환하는 것을 막는다. 일반적으로는 64 혹은 128이라는 값을 설정하며, 이는 지구 반대편까지 경유하는 라우터 수가 많아야 수십개인 것을 고려하면 충분히 큰 값이다. 

라우터의 포트 부분이 LAN이나 통신 회선인 경우 그 종류에 따라 패킷의 최대 길이가 달라지거나, 헤더가 부가되면서 패킷의 실질적 길이가 짧아지기도 한다. ADSL, FTTH와 같은 광대역 액세스 회선에서 PPPoE를 사용하는 경우가 그 예시이다. 이런 경우에는 IP 프로토콜에 규정된 Fragmentation 방법으로 패킷을 분할하여 중계한다. 

이때 IP 헤더 플래그 필드에서 분할 불가로 지정했거나 이미 패킷이 분할되어 있는 경우에는  분할할 수 없으므로 폐기하고 ICMP 메시지를 송신처에 통지한다. 분할이 가능하다면 TCP 헤더부터 데이터 부분으로 간주하여 출력측의 MTU(한 패킷 당 최대 데이터 길이)에 맞춰 앞부터 잘라낸다. 이후 원래 패킷의 IP 헤더를 복사하고 관련 필드만 일부 갱신한 뒤 분할된 데이터에 붙인다. 

<br/>

# **5. 라우터의 송신**

패킷의 송신 동작은 출력측에 포트에 따라 달라진다. 이더넷이라면 이더넷 규칙에 따라, ADSL이라면 ADSL의 규칙에 따라 신호를 변환하여 송신한다. 이 중 이더넷의 패킷 송신 동작은 프로토콜 스택 IP 담당 부분이 패킷을 보낼 때와 유사하게 동작한다. 패킷 맨 앞에 MAC 헤더를 부가하고, 값을 설정하여 패킷을 완성시킨 후, 전기 신호로 변환해서 보내는 것이다. 

MAC 주소 필드에 값을 설정할 때는 경로표의 게이트웨이 항목을 사용한다. 만약 이 항목에 IP 주소가 끄여있지 않다면 IP 헤더의 수신처 IP 주소가 건네줄 대싱이 된다. 그 이후엔 ARP로 IP 주소에서 MAC 주소를 조사하고 그 결과를 수신처의 MAC 주소로 설정한다. 송신처의 MAC 주소는 출력측 포트에 할당된 MAC 주소로 설정한다. 

송신 패킷 완성 이후 전기신호로 변환하는 것 역시 동일하게 반이종 모드인지 전이중 모드인지에 따라 결정될 것이다. 출력측 포트가 이더넷이면 송신 패킷은 스위칭 허브를 경유하여 다음 라우터에 도달한다. 수신처 MAC 주소에 다음 라우터 주소가 쓰여있으므로 스위칭 허브가 이를 바탕으로 패킷을 운반할 것이며, 이 과정을 반복해 목적지에 도착한다. 

<br/>

# **6. 라우터와 스위칭 허브**

라우터는 IP 개념에 기초해서, 스위칭 허브는 이더넷에 기초해서 만들어졌기 때문에 IP와 이더넷의 관계가 라우터와 스위칭 허브의 관계를 나타낸다. 그동안 라우터가 패킷을 중계할 때 MAC 헤더를 부가한다고 표현했지만, 이는 이더넷 패킷의 데이터 부분에 IP의 패킷을 넣는다고 표현하는 게 정확하다. IP는 스스로 패킷을 운반하는 수단이 없기 때문에 이더넷에 의뢰하여, 이더넷의 원리로 다음 라우터까지 운반한다. 

이때 IP가 이더넷에 의뢰하는 것은 패킷을 최종 목적지가 아니라 다음 라우터까지만 운반하는 것이다. 즉, 통신 상대까지 패킷을 전달하는 전체 동작은 IP(라우터)가, 다음 라우터까지 패킷을 운반하는 부분은 이더넷(스위칭 허브)가 담당하는 셈이 된다. 만약 라우터 사이가 무선 LAN으로 연결되어있다면 동일하게 무선 LAN에 의뢰할 것이다. 실제로는 스위칭 허브를 내장한 라우터도 많기 때문에, 이는 개념적인 설명일 뿐 실제 기기들이 모두 이 설명을 따르는 것은 아니다.