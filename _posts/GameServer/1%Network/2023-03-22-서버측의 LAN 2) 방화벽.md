---
title: 서버측의 LAN 2) 방화벽
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 패킷 필터링**

방화벽의 기본 개념은 특정 서버와 특정 애플리케이션에 액세스 하는 패킷만 통과시키고 그 외에는 차단하는 것이다. 이를 위해 패킷 필터링을 거치게 되는데 패킷 헤더의 제어 정보 중 주소, 포트 번호, TCP 컨트롤 비트, 프로토콜 번호, 프래그먼트와 같은 항목을 사용한다. 방화벽은 통과 판정을 내린 패킷의 경우 라우터와 동일한 방식으로 패킷을 중계한다. 또, 향후 부정 침입 대책을 세우기 위해 차단한 패킷은 기록을 남긴다. 

이 중 송수신처 주소를 이용하여 수신처 IP 주소가 일치하는 패킷과 웹서버에서 인터넷측으로 가는 패킷만 통과시키는 것이 가장 기본적인 동작이다. 또, 웹 서버의 포트 번호만 통과시킴으로써 서버 안에서 네트워크를 경유해 파일에 접근하는 경우를 막을 수 있다. 액세스 방향을 필터링할 때는 TCP 헤더에 있는 컨트롤 비트를 사용하여 웹서버에서 인터넷에 액세스 하는 것만을 막는다.

컨트롤 비트를 사용하는 방법은 다음과 같다. 컨트롤 비트의 경우 최초 패킷만 SYN가 1, ACK가 0이 되므로 최초 패킷과 이후 패킷을 판별할 수 있는데, 최초 패킷을 차단하면 이후 패킷은 자동으로 돌아오지 않으므로 접속에 실패한다. 인터넷에서 웹서버에 액세스 하는 경우 최초 패킷은 수신처가 웹 서버를 나타내므로 필터링을 통과하고 이후 패킷은 컨트롤 비트 조건이 합치되지 않으므로 필터링을 통과하게 된다. 

방화벽으로 선별할 수 없는 상황도 있는데 대표 예시가 DNS 서버 액세스이다. DNS 서버 조회는 UDP를 사용하는데 UDP는 TCP와 달리 접속 단계 동작이 없어서 컨트롤 비트로 액세스 방향을 판별할 수 없다. 따라서 사내에서 DNS 서버에 액세스 하는 것만 허가하고, 인터넷에서 사내 DNS 서버에 액세스 하는 패킷을 차단할 수 없다. 이는 UDP를 사용하는 상황에서 공통이기 때문에 다 통과시키거나 다 차단하는 방법을 선택해야 한다. 

<br/>

# **2. 사내 LAN에서의 사용**

공개 서버용 LAN과 사내 LAN이 방화벽을 사이에 두고 별개로 존재하여 인터넷에 연결되는 경우, 인터넷 - 공개 서버용 LAN 왕래 패킷 조건과 더불어 사내 LAN - 인터넷, 사내 LAN - 공개 서버용 LAN의 왕래 패킷 조건도 설정해야 한다. 이때 사내 LAN에서 편하게 사용하기 위해 수신처 IP가 공개 서버용 LAN과 일치하는 패킷을 전부 통과시킨 후, 송신처 주소를 설정하지 않을 경우 공개 서버용 LAN이 위험해지므로 유의하여 설정해야 한다. 

패킷 필터링형 방화벽은 주소 변환의 기능도 가지고 있는데, 인터넷과 사내 LAN을 왕래하는 패킷은 주소 변환을 해야 하므로 이에 대한 설정이 필요하다. 보통 패킷 시점과 종점을 조건으로 지정한 후 변환이 필요한 경우에 한해 변환하도록 설정한다. 이때 주소 변환을 이용하면 자연스럽게 인터넷에서 사내 LAN에 액세스 할 수 없게 되므로 이에 대한 패킷 필터링 조건은 설정하지 않아도 된다. 

<br/>

# **3. 방화벽의 한계**

방화벽은 기본적으로 패킷 흐름의 시점과 종점으로 판단하는데, 이것만으로 위험한 패킷을 모두 판단할 수는 없다. 패킷 안에 특정 버그가 있는 웹 서버를 다운시킬 수 있는 특수한 데이터가 포함되어 있어도 방화벽은 데이터 내용까지 조사하진 않으므로 그대로 통과시킬 것이다. 이런 문제는 웹 서버의 버그를 고쳐서 다운을 막거나, 데이터까지 확인하여 차단하는 소프트웨어를 별도로 준비하여 해결해야 한다. 