---
title: TCP-IP 01) 소켓 작성하기
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **0. Intro**

**-** 지금 통용되는 이더넷 헤더 포맷은 IEEE802.3 국제 표준 이전의 사양을 따르고 있다. IEEE802.3 국제 표준의 경우 헤더 길이가 길어져 효율이 저하되기 때문에 보급되지 않고 있다. 

**-** 최초에는 TCP/IP가 하나로 묶은 형태로 고안되었다가 나중에 TCP와 IP 두가지 프로토콜로 분리되었다. 

**-** 1960년대 이전에는 전화와 같이 회선을 연결하는 통신 방식만 존재했으나, 이러한 방식은 연결된 상대와만 통신할 수 있 컴퓨터에서 사용하기엔 부적합했다. 이에 따라 컴퓨터의 데이터 통신용으로 패킷을 사용하는 통신 기술이 고안되었다. 

<br/>

# **1. 프로토콜 스택의 구성**

![image](https://user-images.githubusercontent.com/96677719/224892744-81186a0f-3247-4d8a-bd4d-e58ca9608afe.png)

프로토콜 스택은 OS에 내장된 네트워크 제어용 소프트웨어로, 위 그림은 프로토콜 스택 내부를 표현한 것이다. 의뢰하는 것을 위쪽, 의뢰를 받아 작업을 수행하는 것을 아래쪽에 배치했으나 이는 경향일 뿐 상하 관계가 엄밀하게 정해져있지는 않다. 

맨 위에 있는 것은 네트워크 애플리케이션으로, 브라우저, 메일러, 웹 서버, 메일 서버 등의 프로그램이 여기에 해당한다. 이 아래 Resolver를 포함한 Socket 라이브러리가 있어서 프로토콜 스택에 명령을 의뢰할 수 있도록 도와준다. 

OS 내부에는 프로토콜 스택이 있는데 TCP/UDP 프로토콜을 이용해 송수신을 담당하는 부분이 각각 존재한다. 보통 브라우저, 메일링 등 일반적인 애플리케이션은 TCP로, DNS 서버 조회 등 짧은 제어용 데이터 송수신의 경우 UDP를 사용한다. 

그 아래에는 IP 프로토콜을 이용해 패킷 송수신을 제어하는 부분이 있다. 인터넷에서는 데이터를 작게 나누어 패킷 형태로 운반하는데, 이를 운반하는 것이 IP의 주 역할이다. ICMP는 운반 시 발생하는 오류 및 제어 메시지 통지에, ARP는 이더넷 MAC 주소 조사에 사용된다. 

IP 아래의 LAN 드라이버는 LAN 어댑터의 하드웨어를 제어하기 위한 것이다. 그 아래의 LAN 어댑터는 OS에 내장된 네트워크용 하드웨어로, 케이블에 대해 실제 신호를 송수신 하는 동작을 실행한다. 이러한 경로를 거쳐 데이터 송수신이 이루어진다.

<br/>

# **2. 통신 제어용 제어 정보**

프로토콜 스택은 내부에 제어 정보를 기록하는 메모리 영역을 갖고 있으며, 여기에 상대의 IP 주소, 포트 번호, 통신 동작의 진행 상태 등 통신 동작 제어를 위한 제어 정보를 기록한다. 소켓은 원래 실체가 없는 개념적인 것이지만, 이러한 제어 정보를 기록한 메모리 영역을 두고 소켓이라 해석할 수도 있다. 

프로토콜 스택은 이러한 제어 정보, 소켓을 참조하며 동작한다. 예를 들자면 소켓에는 응답이 돌아오는지 여부와 송신 동작 후 경과 시간 등이 기록되어 있어서, 데이터가 원활히 오고가지 않을 때 이 정보를 바탕으로 다시 보낼지 기다릴지 등의 판단을 내릴 수 있다. 

윈도우의 경우 netstat 명령으로 소켓 내용을 화면에 표시할 수 있는데, 이때 나타나는 한 행이 하나의 소켓에 해당한다. 즉, 소켓을 만든다는 것은 여기에 새로 한 행의 제어 정보를 추가하고 여기부터 통신을 시작한다는 식으로 상태를 기록하거나, 송수신 데이터를 일시적으로 저장하는 버퍼 메모리를 준비하는 작업이라 볼 수 있다. 

<br/>

# **3. 소켓 호출 시의 동작**

처음 socket을 호출하여 소켓 만들기를 의뢰하면 프로토콜 스택이 직접 소켓을 만든다. 이때 프로토콜 스택이 최초로 하는 일은 소켓 하나 분량의 메모리 영역, 즉 제어 정보를 담기 위한 공간을 확보하는 것이다. 아직 연결이 되기 전이므로 이때는 초기 상태임을 나타내는 제어 정보가 기록된다. 

소켓이 만들어지고 나면 디스크립터를 애플리케이션에 반환하고, 이후 이것을 통해 애플리케이션이 프로토콜 스택에 송수신 동작을 의뢰할 수 있게 된다. 소켓에는 누구와 누가 통신하는지, 어떤 상태로 있는지 등이 기록되어 있으므로 통신 상대의 정보를 애플리케이션이 일일이 통지 받을 필요가 없어진다. 