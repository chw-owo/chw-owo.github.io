---
title: Task 06) Thread Sync - Kernel
categories: WindowsViaC-Cpp
tags: 
toc: true
toc_sticky: true
---

이 포스트는 <제프리 리처의 Windows via C/C++ (한빛미디어)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 대기 함수**

## **1) 커널 오브젝트 동기화**

유저 모드 동기화는 빠르다는 장점이 있지만 복잡한 작업을 수행하기에는 한계가 많다. 우선 단일 프로세스 내 스레드들 사이에서만 동기화를 수행할 수 있으며, 대기 시간을 설정할 수 없기 때문에 데드락 상태에 빠지기 쉽다. 이를 보완하기 위해 커널 오브젝트를 이용해 스레드 동기화를 진행할 수 있다. 이 경우 커널모드로의 전환이 필요하기 때문에 성능이 좋지 못하지만 보다 복잡한 작업을 수행할 수 있다. 

프로세스, 스레드, 잡과 같은 커널 오브젝트 뿐 아니라 대부분의 커널 오브젝트는 signal/non-signal 상태를 지원하기 때문에 동기화를 위해 사용될 수 있다. 예를 들어 프로세스와 시그널은 non-signal 상태로 생성되어서, 종료되는 시점에 운영체제에 의해 자동으로 signal 상태가 되는데 이를 체크할 경우 해당 오브젝트가 종료되었음을 알 수 있고 이를 바탕으로 대기 중인 스레드의 수행을 재개하도록 요청할 수 있다. 

signal/non-signal 상태에 대한 규칙은 오브젝트 타입 별로 상이하며, 마이크로소프트는 이러한 작업을 손쉽게 할 수 있는 함수들을 제공한다. 가장 대표적인 것이 대기함수이다. 대기함수를 호출하면 인자로 전달한 커널 오브젝트가 signal 상태가 될 때까지 해당 함수를 호출한 스레드를 대기 상태로 유지한다. 

## **2) 대기 함수**

```c++
DWORD WaitForSingleObject(
    HANDLE hObject,
    DWORD dwMilliseconds
);
```

WaitForSingleObject는 가장 흔하게 쓰이는 대기 함수이다. 잘못된 인자를 전달할 경우 WAIT_FAILED를, 대기하던 오브젝트가 signal이 되었다면 WAIT_OBJECT_0을, 그 전에 타임아웃이 발생하였다면 WAIT_TIMEOUT을 반환한다. 

```c++
DWORD WaitForMultipleObjects(
    DWORD dwCount,
    CONST HANDLE* phObjects,
    BOOL bWaitAll,
    DWORD dwMilliseconds
);
```
WaitForMultipleObjects는 여러개의 커널 오브젝트를 기다릴 떄 사용하는 함수로, dwCount는 검사해야 하는 커널 오브젝트의 개수를 전달한다. bWaitAll로 TRUE를 전달할 경우 모든 오브젝트들이 signal 상태가 될 때까지 기다린다.

만일 bWaitAll을 FALSE로 전달할 경우 하나만이라도 signal이 되면 대기 상태에서 빠져나오게 된다. 이떄 반환 값은 WAIT_OBJECT_0과 WAIT_OBJECT + dwCount - 1 사이의 값이 된다. 즉, 반환 값에서 WAIT_OBJECT_0을 뺀 값이 signal된 오브젝트가 저장된 배열의 인덱스라고 볼 수 있다. 

이러한 WaitForMultipleObjects 함수는 모든 오브젝트 상태를 확인하는 작업부터 이후 설명할 성공적 대기로 인한 오브젝트 상태 변경 작업까지 모두 원자적으로 수행해주기 때문에 상당히 유용하다. 

## **2) 성공적 대기의 부가적인 영향**

대기 함수가 WAIT_OBJECT_0을 반환하는 경우를 두고 성공적 호출이라고 부르는데, 일부 커널 오브젝트는 대기 함수가 성공적으로 호출될 경우 오브젝트의 상태가 변경되기도 한다. 이를 두고 '성공적인 대기의 부가적인 영향'이라고 부른다. 예를 들어 자동 리셋 이벤트 커널 오브젝트 핸들을 매개변수로 대기 함수를 호출할 경우, signal이 되어서 WAIT_OBJECT_0을 반환하는 동시에, 반환 직전 이러한 영향으로 인해 non-signal 상태로 변경된다. 

<br/>

# **2. 이벤트 커널 오브젝트**

## **1)**

<br/>


# **3. 대기 타이머 커널 오브젝트**

## **1)**

<br/>


# **4. 세마포어 커널 오브젝트**

## **1)**

<br/>


# **5. 뮤텍스 커널 오브젝트**

## **1)**

<br/>

# **6. 편리한 스레드 동기화 오브젝트들**

## **1)**

<br/>

# **7. 그 외 스레드 동기화 함수**

## **1)**

<br/>
