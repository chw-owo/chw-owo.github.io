---
title: TCP-IP 05) IP와 이더넷 패킷 송수신
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 패킷의 기본**

TCP 담당 부분은 데이터를 패킷으로 만들고 IP 담당 부분은 의뢰를 받아 패킷을 상태에게 송신한다. 패킷은 헤더와 데이터로 구성되며, 헤더에는 수신처를 나타내는 주소 등의 제어정보가 포함된다. 보통 TCP 헤더와 데이터 조각이 패킷의 내용이 되며 이에 IP 헤더를 붙인 것이 IP의 패킷, IP 패킷에 이더넷 제어 정보가 담긴 MAC 헤더를 붙인 것이 이더넷의 패킷이 된다. 

패킷을 가장 가까운 중계 장치에 송신하면 중계 장치는 헤더의 수신처와 중계처에 등록된 정보를 결합해 패킷의 목적지를 정하고 다음 중계 장치로 전송한다. 이런 방식으로 중계를 이어가다보면 수신처에 도착하며, 수신처에서 송신처로 회답 패킷을 보낼 때도 동일하게 동작한다. 이처럼 송신처와 수신처를 구분할 필요가 없는 경우, 이들을 묶어 엔드노드라고 부른다. 

패킨 중계 장치에는 라우터와 허브가 있는데, 라우터는 목적지를 확인하여 다음 라우터를 나타내고 허브는 서브넷 안에서 패킷을 운반하여 다음 라우터에 보낸다. 라우터는 IP 규칙을, 허브는 이더넷 규칙을 따라서 패킷을 운반하기 때문에 다른 말로 표현하자면 라우터는 IP가 목적지를 확인하여 다음 IP 중계 장치를 나타내는 걸로, 허브는 서브넷 안에 있는 이더넷이 중계 장치까지 패킷을 운반하는 걸로 볼 수도 있다. 

TCP/IP 패킷에는 이더넷용 MAC 헤더와 IP용 IP 헤더가 붙어있다. 먼저 액세스 대상의 IP 주소를 IP 헤더 수신처에 기록하고, IP는 이 수신처가 어느 방향에 있는지 다음 라우터가 누구인지 조사하여 해당 라우터에 패킷이 도착하도록 이더넷에 의뢰한다. 이때 다음 라우터에 할당된 이더넷의 주소, MAC 주소를 조사하여 이를 MAC 헤더에 기록한다. 이런 방식으로 이더넷에게 어느 라우터에 가야 하는지 전달한다. 

이후 패킷은 이더넷 원리에 따라 움직이는 허브에 도착한다. 허브에는 목적지 판단을 위한 이더넷용 표가 있어서 이더넷 헤더의 수신처 정보와 표를 결합해 패킷을 목적지로 중계한다. 그러면 패킷은 다음 라우터에 도착하고 마찬가지로 라우터도 IP용 표를 바탕으로 패킷을 중계할 곳을 결정한다. 다음 라우터에 패킷을 건네기 위해 라우터 MAC 주소를 조사한 다음 이를 MAC 헤더에 기록, 패킷을 송신한다. 

위 흐름에서 IP와 이더넷이 역할을 분담하는 것을 볼 수 있는데, 이때 무선 LAN, ADSL, FTTH 등 IP 의뢰로 패킷을 운반할 수 있는 것이라면 뭐든 이더넷 대신 IP와 조합하여 적재적소에 사용할 수 있다. 거대한 네트워크 구축을 위해서는 이와 같은 유연성이 필요하기 때문에 역할을 분담하여 사용한다. 

<br/>

# **2. 패킷 송수신 동작 개요**

패킷 송수신의 출발점은 TCP 담당 부분이 IP 담당 부분에 패킷 송신을 의뢰하는 것에서 시작된다. TCP 담당 부분은 데이터 조각에 TCP 헤더를 부가하여 IP 담당 부분에 건네준다. IP 담당 부분은 IP 헤더와 MAC 헤더를 붙이는데 IP 헤더는 IP 주소 목적지 정보를 담고 있다. MAC 헤더는 이더넷 등의 LAN을 사용하여 가장 가까운 라우터까지 패킷을 운반할 때 사용하는 제어 정보를 담고 있다. 

이후 이렇게 만든 패킷을 이더넷, 무선 LAN과 같은 네트워크용 하드웨어에게 건네준다. 이때 패킷의 모습은 0이나 1의 bit가 이어진 디지털 데이터의 형태이며, 이것이 하드웨어에 의해 전기나 빛 신호 상태로 바뀌어 케이블에 송출된다. 헤더를 붙이고 송출하는 것까지가 IP 담당 부분의 역할이며 이후 패킷을 운반하는 것은 라우터, 허브와 같은 네트워크 기기의 역할이 된다. 

수신 동작은 역으로 LAN 어댑터가 신호를 디지털 데이터 모습으로 전환, 이를 IP 담당 부분에게 전달하는 순서로 이루어진다. 그러면 IP 담당 부분이 MAC 헤더, IP 헤더 뒤에 있는 TCP 헤더와 데이터 조각을 TCP 담당 부분에게 건넨다. 이때 IP 담당 부분은 TCP 헤더와 데이터의 내용을 보지 않고 한 덩어리의 바이너리 데이터로 간주한다. 내용물에 상관 없이 패킷으로 만들어 송수신할 뿐이다. 

<br/>

# **3. IP 헤더**

IP 헤더는 IP 프로토콜 버전, 헤더 길이, 서비스 유형, 전체 길이, 생존 기간, 프로토콜 번호, 송신처와 수신처의 IP 주소 등으로 이루어져있다. 수신처의 IP 주소는 애플리케이션에서 통지한 것을 그대로 사용하며, 송신처의 IP 주소는 컴퓨터에 할당된 IP 주소로 설정된다. 만약 복수의 LAN 어댑터를 장착하고 있다면 여러개의 IP 주소가 할당되므로 이 중 하나를 골라서 사용하게 된다. 패킷을 건네줄 상대를 판단하는 방법은 라우터가 IP용 표를 사용하여 다음 라우터를 결정하는 것과 동일하다. 이 IP용 표를 경로표라고 부른다. 

경로표로 경로를 찾을 때는 우선 Network Destination 항목과 비교하여 왼쪽 부분이 일치하는 것을 찾아낸다. 그 이후엔 LAN 어댑터와 같은 네트워크용 인터페이스를 나타내는 Interface 항목을 비교한다. 마지막으로 Gateway 항목에는 다음 라우터의 IP 주소를 기록하면 해당 목적지까지 패킷을 중계해준다. 경로표 맨 위 행에는 넷 마스크가 0.0.0.0으로 등록되어 있는데 이는 기본 게이트웨이를 나타내서 일치하는 것이 없다면 이걸로 간주한다. 또 프로토콜 번호라는 필드에도 값을 설정하는데, 이 값은 어디서 의뢰받았는지를 나타낸다. 예를 들어 TCP라면 0x06, UDP라면 0x17을 표기한다.

<br/>

# **4. MAC 헤더와 ARP**

MAC 헤더는 수신처, 송신처의 MAC 주소와 프로토콜 종료를 나타내는 Ether Type으로 구성되어 있다. IP주소는 그룹화 개념으로 사용되는 것과 달리 MAC 주소는 48bit가 하나의 단일한 값으로 사용된다. Ether Type은 IP 헤더의 프로토콜 번호와 비슷한데, IP 프로토콜을 나타내는 0800과 ARP 프로토콜을 나타내는 0806이 대표적으로 많이 사용된다. 송신처 MAC 주소에는 사용하려는 LAN 어댑터 내 ROM에 기록된 MAC 주소를 설정한다. 

수신처 MAC 주소는 다소 복잡한데, 경로표에서 일치하는 행의 Gateway에 기록된 IP 주소의 기기가 수신할 상대가 된다. 그리고 IP 주소에서 MAC 주소를 조사하는데 여기서 사용되는 게 ARP이다. 이더넷에서는 브로드캐스트로 연결된 전원에게 패킷을 전달할 수 있는데, 이를 이용해 해당 IP 주소를 가진 기기로부터 MAC 주소를 회답받는다. 이렇게 회답받은 MAC 주소를 MAC 헤더에 설정한다. 

패킷을 보낼 때마다 이 동작을 하면 ARP의 패킷이 불어나기 때문에 한번 조사한 결과는 ARP 캐시라는 메모리 영역에 보존하여 다시 이용한다. 패킷을 송신할 땐 우선 ARP 캐시를 조사하여 거기에 MAC 주소가 있을 경우 ARP를 조회하는 대신 그 값을 그대로 사용한다. 그러나 IP 주소가 달라지만 이 값도 달라지므로 시간이 지나면 ARP 캐시에 저장된 값도 삭제 된다. 

이와 같은 과정을 거쳐서 MAC 헤더를 IP 헤더 앞에 붙이는 것까지가 IP 담당 부분의 역할이다. 이후엔 완성된 패킷을 건네받은 LAN 어뎁터가 패킷을 송신하기만 하면 된다. 이러한 방법을 사용하면 IP 이외의 특수한 패킷도 한개의 LAN 어댑터로 대응할 수 있게 된다. 

<br/>

# **5. 이더넷의 기본**

![image](https://user-images.githubusercontent.com/96677719/225828347-8d3907a8-6d88-4f92-87a0-ce29fc6110c0.png)

이더넷은 다수의 컴퓨터가 여러 상대와 적은 비용으로 통신하기 위해 고안된 기술이다. 이더넷의 원형은 a와 같으며 이 경우 네트워크의 물리적 실체는 케이블과 케이블 사이에 신호를 흘리는 트랜시버 케이블만 존재했다. 이때는 신호를 보내면 연결된 전원에게 신호가 도착했으며, 수신처 주소를 확인하여 자신과 일치하면 수신하고 아니면 폐기하는 방식을 사용했다. b의 모습으로 변하면서 케이블은 리피터 허브로, 트랜시버 케이블은 트위스트 페어 케이블로 바뀌었으나 동작 방식은 원형과 동일했다. 

그러던 중 c와 같이 스위칭 허브를 사용한 형태가 보급되면서 현재의 이더넷이 생겨났다. 전원에게 신호를 전달하는 대신, 수신처 MAC 주소로만 신호를 전달하고 다른 부분엔 신호가 흐르는 것을 막게 된 것이다. 그러나 수신처 MAC 주소 상대에게 패킷이 전달되는 점은 그대로이기에 MAC 헤더의 개념도 그대로 이어지게 되었다. 이더넷에 접속된 기기는 이더넷이라는 하나의 사양에 기초하여 동작하며 IP와 마찬가지로 패킷의 내용물에 상관 없이 일관되게 송수신 동작을 수행한다. 

<br/>

# **6. LAN 어댑터**

LAN 어댑터는 LAN 드라이버 소프트웨어의 제어를 받아 디지털 데이터를 전기나 빛 신호로 변환하여 네트워크 케이블에 송출한다. LAN 어댑터에서 데이터가 오가는 중요 구성 요소는 버퍼 메모리 - MAC - PHY(MAU) - 커넥터로 이루어져있다. 버퍼 메모리는 패킷을 일시적으로 저장하는 메모리, MAC은 충돌 검출, 재송신 등의 이더넷 송수신 동작을 제어하는 영역, PHY(MAU)는 신호 송신 회로와 신호 수신 회로를 합친 영역, 커넥터는 LAN 케이블을 접속하는 커넥터를 의미한다. 그리고 이와 별도로 MAC 주소를 기입하는 ROM이 존재한다. 이것은 개념적인 설명으로 실제 하드웨어의 구조를 나타내는 것은 아니다. 

LAN 어댑터는 전원을 공급한 후 OS를 시동할 때 LAN 드라이버가 하드웨어 초기화 작업을 수행해야 사용 가능한 상태가 된다. 초기화 작업에는 MAC 회로에 MAC 주소를 설정하는 일이 포함된다. LAN 어댑터의 ROM에는 제조 시 중복되지 않도록 일원화하여 관리되는 MAC 주소를 기록하기 때문에 이 값을 불러와서 회로에 설정하게 된다. 상황에 따라 명령으로 MAC 주소를 받아 설정할 수도 있는데 이러면 ROM에 기록된 주소는 무시된다. OS를 가동하면 이러한 초기화 작업을 끝낸 후 IP에서 의뢰가 오기를 기다리게 된다. 

<br/>

# **7. 패킷 제어용 데이터**

LAN 드라이버는 IP 담당 부분에서 패킷을 받으면 그것을 LAN 어댑터 버퍼 메모리에 복사한다. 복사를 마친 후 패킷을 송신하도록 MAC 회로에 명령하면 MAC 회로의 작업이 시작된다. 이때 이름만 보면 MAC 헤더를 LAN 어댑터에서 처리한다고 생각할 수도 있지만 이 작업은 TCP/IP 소프트웨어가 처리한 뒤 보낸다. MAC 회로는 송신 패킷 맨 앞에 프리앰블과 스타트 프레임 딜리미터(SFD)라는 두개의 데이터를 순서대로 붙이고, 맨 끝에는 프레임 체크 시퀀스(FCS)라는 오류 검출용 데이터를 붙인다. 

프리앰블은 송신 패킷을 읽을 타이밍을 잡기 위한 것으로 101010... 과 같은 56bit 비트열이고, SFD는 1010101011으로 구성된 8bit 비트열이다. 수신측은 프리앰블로 수신 타이밍을 맞추고 SFD의 11로 개시 위치를 판단한다. FCS는 패킷 운반 도중 잡음 등의 영향으로 파형이 흐트러져 데이터가 변한 것을 검출하기 위해 사용한다. 이것은 패킷 전체 내용을 특정한 방식으로 계산한 32bit의 비트열이다. 만약 데이터가 변했다면 이 값이 송신할 때와 다른 값이 되기 때문에 데이터 오염을 검출할 수 있다. 

이때 프리앰블 영역의 파형이 101010... 그대로 출력되지는 않는다. 거리가 멀어져서 케이블이 길어지면 신호선의 길이가 달라져 데이터 신호와 클록 신호가 전달되는 시간에 차이가 생기기 때문에 이것만으로는 타이밍을 맞추기 어렵다. 따라서 실제로는 프리앰블 데이터 신호와 bit 구분을 나타내는 클록 신호를 합쳐서 보낸다. 그럼 수신측에서는 수신한 신호에서 클럭 신호를 추출하여 원래 데이터 신호를 추출할 수 있게 되고 클록 신호로 타이밍을 잡으면 데이터 신호에서 비트값을 읽을 수 있게 된다. 

<br/>

# **8. 반이중 모드에서의 패킷 송신**

신호 송신에는 리피터 허브를 사용하는 반이중 모드와 스위칭 허브를 사용하는 전이중 모드 두가지 방식이 있다. 반이중 모드는 먼저 케이블 상에 다른 기기가 송신한 신호가 있는지 조사한 뒤, 있을 경우 끝날 때까지 기다렸다가 송신 동작을 시작한다. 송신 동작은 MAC 회로가 프리앰블 맨 앞 1bit씩 차례로 전기신호로 변환해 PHY(MAU)에 보낸다. 이때 PHY(MAU) 회로는 이 신호를 케이블에 송출 가능한 형식으로 변환하여 송신하는 일종의 변환 회로이다.

PHY(MAU) 회로가 MAC에서 받은 신호를 송신할 때, 단지 송신 동작만 실행하지 않고 수신 신호선에서 신호가 흘러들어오는지를 감시한다. 송신 개시 전 신호가 없는 것을 확인했으니 송신 시작 당시에는 신호가 없을 것이며, 신호 송신을 완료할 때까지 수신 신호선에 신호가 들어오지 않으면 송수신 동작이 끝날 것이다. 이더넷은 송신 신호가 상대에게 도착했는지 확인하지 않으며 오류가 발생해도 프로토콜 스택의 TCP가 이를 검출하므로 신호 송신 단계에서는 오류를 확인하지 않는다. 

낮은 확률로 복수의 기기가 동시에 송신 동작에 들어가서 수신 신호선에 신호가 들어올 수도 있는데 반이중 모드에서는 이렇게 되면 서로의 신호가 뒤섞여버리며 이러한 상황을 충돌이라 부른다. 이렇게 되면 송신 동작을 중지하고 충돌 사실을 다른 기기에게 알리기 위해 재밍 신호를 보낸 뒤 잠시 기다렸다가 재송신을 한다. 이떄 재 충돌이 일어나지 않도록 MAC 주소를 바탕으로 난수를 생성하여 대기시간을 결정하고, 또 다시 충돌할 경우 대기 시간을 2배로 늘린다. 이 상황이 10번 반복되면 오류로 판단한다. 

<br/>

# **9. 패킷 수신**

반이중 모드 이더넷에서는 송신 신호가 리피터 허브에 접속된 모든 케이블로 흘러간다. 수신 동작은 이러한 신호를 전부 받아들이는 것에서 시작한다. 신호 맨 앞의 프리앰블로 타이밍을 계산하고, SFD 다음 비트부터 데이터로 변환한다. 먼저 PHY(MAU) 회로에서 신호를 공통 형식으로 변환하여 MAC 회로에 보내면 MAC 회로에서 신호를 앞부터 차례로 디지털 데이터로 변환, 버퍼 메모리에 저장한다. 그 후 FCS를 검사하여 값이 다를 경우, 그리고 MAC 헤더 수신처 MAC 주소가 자신과 다를 경우 패킷을 폐기한다. 둘 다 일치한다면 패킷을 버퍼메모리에 저장, MAC 회로의 할 일이 끝났으므로 수신 사실을 컴퓨터 본체에 통지한다. 

LAN 어댑터가 송수신을 하는 동안 본체는 다른 작업을 하므로 인터럽트로 통지해야 한다. 먼저 LAN 어댑터는 확장 버스 슬롯 부분의 인터럽트 용 신호선에 신호를 보낸다. 이 신호선은 본체의 인터럽트 컨트롤러를 통해 CPU에 연결되어 있어서, 신호가 들어가면 CPU가 실행 작업을 보류하고 OS 내부 인터럽트 처리용 프로그램 쪽으로 전환한다. 그럼 LAN 드라이버가 호출되어 LAN 어댑터를 제어하며 송수신 동작을 마저 실행한다. 인터럽트에는 번호가 할당되어 있으며, 인터럽트 처리용 프로그램이 하드웨어 인터럽트 번호에 따라 드라이버를 등록한다. 과거에는 번호를 수동으로 등록했으나 현재는 PnP 사양에 따라 자동 설정된다. 

인터럽트에 의해 LAN 드라이버가 동작하고 LAN 어댑터 버퍼메모리에서 수신한 패킷을 추출하면 LAN 드라이버는 MAC 헤더 타입 필드 값으로 프로토콜을 판별, 적절한 프로토콜 스택에 건네준다. 이후 프로토콜 스택이 어느 애플리케이션에 대응하는 패킷인지 판단하여 조치를 취한다. 만약 이 값이 0x0800이라면 IP 프로토콜 데이터이므로 TCP/IP 프로토콜 스택에 패킷을 건넬 것이다. 그러면 IP 담당 부분은 IP 헤더 부분의 수신처 주소를 확인하여 LAN 어댑터 할당 주소와 일치한다면 패킷을 수신할 것이고 다르다면 ICMP를 이용해 상대에게 오류를 통지할 것이다. 

수신처 IP 주소가 올바를 경우 패킷들을 수신한 후, 분할되었던 패킷을 원래 모습으로 되돌리는 리어셈블링 동작을 한다. 플래그 항목을 통해 분할된 패킷인지 확인한 후, 분할된 것일 경우 IP 담당 부분 메모리에 일시적으로 보관하며 같은 ID 정보의 패킷들이 도착하기를 기다린다. 모두 모일 경우 각 패킷의 원리 위치를 나타내는 fragment offset 값을 바탕으로 리어셈블링을 한다. 그리고 리어셈블링 된 패킷을 TCP 담당 부분에 건네주면 이것으로 IP 담당 부분의 역할은 끝난다. 

TCP는 IP 헤더에 기록된 송수신처의 IP 주소, TCP 헤더에 기록된 송수신처 포트 번호 등을 조사하여 해당하는 소켓을 찾고, 소켓에 있는 통신 진행 상태에 따라 적절한 동작을 실행한다. 만약 이미 연결 끊기 단계에 들어가있다면 응답의 제어용 패킷을 반송하는 등 상황을 통지할 것이며, 애플리케이션의 데이터를 넣은 패킷이 있다면 수신 확인 패킷을 반송한 후 데이터를 수신 버퍼에 저장하고 애플리케이션이 가지러 오기를 기다릴 것이다. 



