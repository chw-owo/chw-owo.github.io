---
title: 서버측의 LAN 4) 서버 부하 분산 - 캐시 서버
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 캐시 서버**

서버 부하 분산을 위해 캐시 서버를 사용할 수도 있다. 클라와 웹 서버 중개 구조를 두고 프록시 구조라고 하며, 캐시 서버는 이를 통해 데이터를 캐시에 저장한다. 프록시는 웹 서버와 클라이언트 사이에 들어가서 웹 서버에 대한 액세스 동작을 중계하는 역할을 하는데, 이때 웹 서버에서 받은 데이터를 디스크에 저장해두고 웹 서버를 대신하여 데이터를 클라에 반송하는 기능을 갖고 있다. 이를 캐시라고 부르며 캐시 서버는 이 기능을 이용한다. 

웹 서버는 액세스 권한 점검, 페이지 내 데이터 내장 등의 처리를 내부에서 실행하므로 데이터를 클라에 송신하기까지 시간이 걸린다. 반면 캐시 서버는 보존해둔 데이터를 읽어서 송신만 하므로 보다 빨리 송신할 수 있다. 물론 캐시에 데이터를 저장한 후 웹 서버의 데이터가 변경되면 이는 사용할 수 없게 된다. 그러나 액세스 동작의 일정 부분은 웹 서버를 번거롭게 하지 않고도 캐시 서버에서 처리할 수 있으므로 성능 향상에 도움이 된다. 

DNS에 캐시 서버를 등록하면 사용자는 캐시 서버로 리퀘스트를 보낸다. 캐시 서버는 데이터가 있는지 확인한 후, 있으면 송신, 없으면 웹 서버에 전달한다. 웹 서버에 전달할 땐 리퀘스트 URI 디렉토리를 보고 판단하며 캐시 서버를 경유했다는 뜻으로 Via 헤더 필드를 추가한다. 웹 서버로부터 응답 메시지를 받았다면 여기에도 Via 헤더 필드를 부가하여 클라에게 전송, 이후 해당 메시지를 캐시에 저장하고 일시를 기록한다. 

이때 캐시 서버는 클라에서 메시지를 받을 땐 서버처럼, 서버에게 메시지를 전달할 땐 클라처럼 동작한다. 또, 이 과정에서 데이터 확인을 위해 If Modified Since 라는 헤더 필드를 추가하여 웹 서버에 보낸다. 서버는 갱신 일시를 비교해 응답 메시지를 반송하며 이는 페이지 데이터 반송하는 것보다 훨씬 부담이 적다. 데이터가 갱신된 경우 최신 데이터를 반송하며, 캐시 서버는 Via 헤더를 부가해 사용자에게 전송, 캐시에 저장한다. 

이렇게 매번 확인하는 대신, 웹 서버에서 데이터를 갱신할 때 이를 캐시 서버에도 바로 반영하도록 하여 캐시 서버의 성능을 높이기도 한다. 이때 동적으로 변하는 페이지는 따로 구분하여서 변하지 않는 부분만 캐시에 저장하도록 해야 한다. 

<br/>

# **2. 포워드/리버스 프록시**

캐시 서버에서 쓰이는 프록시 구조는 원래 클라이언트 측에 두는 방법에서 시작되었는데, 이를 포워드 프록시라고 한다. 포워드 프록시는 캐시 사용과 더불어 방화벽 구현에도 목적이 있었다. 프록시에서 리퀘스트를 받아 인터넷으로 전송하면 전송은 통과하되 오는 것은 막을 수 있으며, 이전에 액세스한 페이지의 경우 사내 LAN에서 프록시에 액세스 하기만 하면 데이터를 빠르게 얻을 수 있다. 또, 리퀘스트 내용을 조사한 후 전송하므로 패킷 필터링형 방화벽보다 촘촘하게 액세스 제한을 걸 수 있다. 

포워드 프록시를 사용할 경우 브라우저 설정 화면의 프록시 서버 항목에 포워드 프록시의 IP 주소를 설정한다. 그러면 URL에 상관 없이 리퀘스트를 모두 포워드 프록시에 보내게 되고, 원래대로면 리퀘스트 URI에 웹 서버 이름을 제외하고 경로명을 추출하여 기입했다면 이제는 URL을 그대로 기록한다. 그렇기에 서버측의 캐시 서버가 설정된 웹 서버에만 전송 가능한 것과 대조적으로 모든 웹 서버에 전송할 수 있게 된다. 

그러나 포워드 프록시는 브라우저 설정이 꼭 필요하다는 문제가 있다. 인터넷 공개 웹 서버는 누가 액세스 하는지 알 수 없고 브라우저에 프록시를 설정할 수 없어서 웹 서버의 바로 앞에는 프록시를 둘 수 없다. 이를 보완하기 위해 브라우저에 프록시를 설정하지 않고 리퀘스트 URI 디렉토리 명과 전송 대상 웹 서버를 대응시켜 리퀘스트를 전송할 수 있도록 한 것이 캐시 서버가 채택한 방식이며, 이를 리버스 프록시라고 부른다.

<br/>

# **3. 트랜스 페어런트 프록시**

캐시 서버에서 전송 대상을 판단할 때 IP 헤더의 수신처 Ip 주소를 바탕으로 액세스 대상 웹 서버를 판단한다. 이를 트랜스 페어런트 프록시라고 부른다. 이 경우 전송 대상을 캐시 서버에 설정하거나 브라우저에 프록시를 설정하지 않아도 어느 웹 서버에서나 전송할 수 있게 된다. 

그러나 트랜스 페어런트 프록시는 DNS 서버에 등록하지 않는다. DNS 서버에 등록하면 이 프록시 자체가 액세스 대상이 되어 수신처 IP 주소로 웹 서버를 판단할 수 없게 된다. 이 상태에서 브라우저는 웹 서버에 리퀘스트를 보내면 웹 서버로 흘러가지 이 프록시에 도착하지 않는다.

이를 해결하기 위해 브라우저에서 웹 서버로 가는 길에 이 프록시를 설치하고, 메시지가 통과할 때 가로채는 구조를 이용한다. 리퀘스트가 흐르는 길이 많다면 길을 한개로 수렴시킨 뒤 그곳에 이 프록시를 설치한다. 이를 사용하면 사용자가 프록시의 존재를 알아차릴 필요 없이 캐시를 이용할 수 있게 된다. 