---
title: Procademy, Q2, 15) Network - select server 실습
categories: ProcademyReview
tags: 
toc: true
toc_sticky: true
---

이 포스트는 프로카데미 (게임 서버 아카데미) 수업을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 부연 설명**

Nagle을 켜면 ACK가 오거나 MSS가 찼을 때 송신이 된다. 이 예제는 패킷을 16byte씩 보내기 때문에 MSS까지 차는 것보다 ACK가 오는 게 더 빠르다. 따라서 Nagle을 적용하면 ACK가 와야 다시 보낼 수 있는 핑퐁 형태가 된다. 그런데 쌍방으로 데이터를 보낼 경우, 그 메시지에 ACK를 같이 실어보내기 때문에 메시지에 대한 ACK가 오지 않아도 핑퐁이 이루어진다. 문제가 되는 상황은 아니며, 그냥 자세히 봤을 때 혼자 움직이는 것보다 같이 움직이는 게 더 매끄럽게 동작하는 것을 볼 수 있는 정도이다.  

보통 게임 서버는 크게 Network - GameLogic - Render로 이루어지지만, 이 경우 네트워크와 렌더만 존재한다. 이 실습 예제를 포함하여 채팅 서버, 로그인 서버 등 수신 메시지가 있어야만 할 일이 있는 컨텐츠는 select time을 NULL로 넣는 것이 효율적이다. 또, FD_ISSET는 반복문을 돌기 때문에, 이를 더욱 효율적으로 쓰고 싶다면 ReadSet을 직접 보고 해당 소켓을 불러올 수 있다. 그러나 이는 정석적인 방법이 아니며 FD 매크로 및 fd_set이 업데이트에 따라 수정될 가능성도 있기 때문에 권장하지 않는다. 

send는 SendUnicast, SendBroadcast 두가지를 구현하게 된다. 여기서 Broadcast는 UDP의 LAN 대상 Broadcast가 아니라 접속한 유저 전체에게 보내는 것을 의미한다. 이때, 게임 특성상 딱 한명만 빼고 데이터를 보내고 싶은 상황이 많이 생기기 때문에 Broadcast 구현은 제외하고 싶은 유저를 인자로 받는 경우가 많다. 참고로 실제 게임에서는 남을 생성하는 메시지 타입과 나를 생성하는 메시지 타입이 따로 있다. 남에 대한 건 외형적 정보만 필요하지만 나에 대한 건 상세한 정보가 필요하기 때문이다. 

send는 recv와 달리 WouldBlock 걸릴 일이 잘 없지만 그래도 예외 처리를 하는 게 일반적이다. WouldBlock 뿐만 아니라 일반적인 연결 종료 시 뜨는 예외들도 (ex 10053, 10054) 처리해주는 게 좋다. 또, 일반적인 예외가 아닌 경우 로그를 남겨서 제대로 파악해야 적절하게 수정할 수 있기 때문에 모든 네트워크 코드에 대해서 err 코드를 출력하는 것이 좋다. 

클라 코드와 달리 비정상적인 유저가 있을 경우 Disconnect를 하고 다른 유저에 대한 작업을 이어가야 한다. Disconnect는 소켓을 닫고, 할당 받은 데이터 지우고, Delete 메시지 만들어서 브로드 캐스트로 send 하는 작업을 한다. 이때 Disconnect의 send 안에서 예외가 발생하면 Disconnect가 재귀적으로 호출되며, 이후에 이전 함수에서 지운 iterator에 접근하게 되면서 CRASH가 발생한다. 따라서 실제로 지우는 작업은 따로 구현해서 일괄적으로 관리하는 것이 안전하다. 
 
또, 소켓 함수를 ret 받는 변수는 재사용하지 말고 함수 행위 별로 만들어서 함수 최상단에 적어두는 게 좋다. 라이브 서비스는 메모리 덤프에서 최대한 많은 정보를 뽑아야 하므로 되도록 최대한 모든 함수의 ret 값을 살려야 한다. 최상단에 적는 것도 확인을 쉽게 하기 위함이다. 물론 이는 불필요하게 메모리를 사용하고 변수의 수명을 너무 길게 늘리는 것이 되지만 그럼에도 디버깅을 위해 습관을 들이는 게 좋다. 

<br/>

# **2. 실습 코드**

```c++

```