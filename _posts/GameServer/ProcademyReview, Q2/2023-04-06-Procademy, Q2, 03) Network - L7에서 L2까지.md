---
title: Procademy, Q2, 03) Network - L7에서 L2까지
categories: ProcademyReview
tags: 
toc: true
toc_sticky: true
---

이 포스트는 프로카데미 (게임 서버 아카데미) 수업을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. L7: 바인딩**

L7 계층은 IP와 port로 구성된 목적지 주소를 바탕으로 아래 계층에 전송을 요청한다. 클라의 IP는 정해져있으며, port는 따로 지정하지 않은 경우 비어있는 port를 사용한다. 이 과정을 바인딩, 이렇게 연결된 번호를 동적 포트라고 하며 보통 연속되어 지정된다. L7은 소켓에 바인딩을 완료한 후 L4로 포트 정보와 함께 데이터를 전달한다.

port는 unsigned short로 한 기기에 65536개가 주어지며 0~1023은 표준처럼 쓰이는 알려진 포트, 1024~49151은 직접 등록해서 사용할 수 있는 등록된 포트, 49152~65535는 동적 포트(사설 포트)라 불린다. 알려진 포트를 개인적으로 사용해도 보통은 지장이 없지만, 포트를 바탕으로 보안 사항을 판단하는 방화벽 등의 기기에서 오해할 가능성이 있다. 

TCP/IP는 헤더 길이, 윈도우 사이즈, 포트 개수 모두 2byte이다. 일반적인 상황에서는 이걸로도 충분하지만, 중복 포트를 지정하거나 포트 개수가 부족할 경우, 혹은 약 16000개 이상 소켓을 바인딩 시도해서 동적 포트 영역을 벗어난 경우 등엔 예외가 생긴다. 이는 윈도우 레지스트리 설정을 수정하여 해결할 수 있으나 잘 생기는 상황은 아니다. 

참고로 클라이언트에서 한번에 접근할 수 있는 서버의 최대치는 포트 최대 개수인 65535인 반면 하나의 서버에 최대 연결 가능한 클라 수는 메모리 한계치까지, 즉 논페이지드 풀이 다 찰 때까지이다. 서버는 포트 하나로 여러 클라를 받을 수 있기 때문에 포트 개수와는 연관이 없다. 

<br/>

# **2. L4: port, TCP 헤더**

L7로부터 데이터와 포트 정보를 받은 L4는 TCP 헤더를 붙인 Segment를 만든다. TCP 헤더는 기본 20byte이며, 헤더를 뺀 나머지 부분을 페이로드 혹은 데이터라고 부른다. 만약 “AAA”를 전송한다면 20 + 3 = 23byte의 메시지가 될 것이다. TCP에는 IP 개념이 없으므로 TCP 헤더에는 포트 번호만 적으며, 이 상황에서는 송신자의 포트 20000, 수신자의 포트 10000가 기록될 것이다. 

<br/>

# **3. L3: IP, IP 헤더**

L4 계층에서는 IP 정보와 함께 TCP 헤더를 붙인 Packet를 전달한다. 그럼 L3 계층은 기본 20 byte의 IP 헤더를 붙이고, 그럼 TCP 헤더 + 기존의 페이로드 전체가 페이로드가 되며, 총 43 byte가 될 것이다. 이때, 추가된 헤더를 매번 사용하는 것은 아니며 처음 연결 단계에서만 사용된다. 

L3에서 L2로 보내기 전에는 IP 주소, Subnet mask, Gateway 설정 작업을 거쳐야 한다. L2의 전달은 장치에서 장치로의 전달이기 때문에 전송 경로와 MAC 주소가 필요하다. 그러나 사용자 입장에서는 MAC 주소를 알 수 없기 때문에, 내부에 MAC 주소 정보가 있다면 그걸로 연결을 하고, 없을 경우 브로드캐스트로 찾아야 한다. 

![image](https://user-images.githubusercontent.com/96677719/230834273-4b246b9b-154a-4ac9-a631-a804adcee7c2.png)

![image](https://user-images.githubusercontent.com/96677719/230835133-3d26fdcb-0aad-4dca-8c64-4816a21ad798.png)

A Class의 경우 0~127은 Network Address, 뒤의 0.0.0~255.255.255는 구매자가 지정하여 사용할 수 있는 Address가 된다. 즉, 10.0.0.0 ~ 255.255.255.255를 하나의 대역대로 묶어서 판매하는 것이며, A Class 하나를 구매할 경우 총 256 x 256 x 256 = 16777216개의 주소를 구매하는 것이 된다. 

그러나 Class는 단위가 너무 커서 관리가 어렵기 때문에 최근에는 서브넷 마스크를 이용한다. 서브넷 마스크는 & 하기 위한 마스크이며 전송 경로 지정에 사용된다. 만약 내 주소가 192.168.0.4라면, 192.168 시리즈의 경우 C Class이므로 서브넷 마스크는 255.255.255.0가 된다. A Class라면 255.0.0.0, B Class라면 255.255.0.0이 될 것이다. 서브넷 마스크로 and 하면 결과는 192.168.0.0와 같이 될텐데 이를 통해 LAN을 구분한다. 

Gateway는 LAN과 WAN을 엮어주는 출입문을 의미한다. 가정에서는 대체로 공유기이며 LAN IP 중 하나의 주소를 갖는데 보통 자동으로 1(192.169.0.1)로 잡는다. 목적지에 서브넷 마스크를 씌웠는데 내 주소에 씌운 값과 다르다면, 즉 내 LAN 안에 없는 값이라면 Gateway를 통해 내보내고, 거기도 없으면 다시 Gateway로 보내며 계속 전달한다. LAN 간의 연결은 엄격한 트리구조가 아니지만 관리 측면에서 유사한 형태를 띄게 된다. 

현 LAN에 있는지 판단하여 직접 보낼지, Gateway로 보낼지는 MAC을 찾아서 그 MAC 주소를 꽂아야 결정 가능한 일이다. 이걸 판단하는 것이 라우팅이며 이 작업을 위한 L3 장치가 라우터이다. 이때 LAN 안에서의 Gateway 주소와 밖에서의 주소가 서로 다르다. 라우터는 밖에서의 주소를 바탕으로 전달할 IP를 탐색하고, 이것은 다음 Gateway가 될 수도, 라우터가 될 수도, 목적지 장치가 될 수도 있다.

route 명령어로 IPv4 경로 테이블 - 활성 경로를 볼 수 있다. IP 주소를 검색할 때 메트릭을 우선 순위로 사용하며, 우선 순위로 같으면 위에서부터 진행할 것으로 추정된다. 인터페이스는 해당 기기로 항하는 이더넷의 IP를 의미한다. 즉, 마스크를 씌워서 동일 주소라면 그 이더넷으로 내보내겠다는 것이지 인터페이스가 목적지라는 뜻이 아니다. 127.0.0.1은 자신을 향하는 loop back IP로, 이 경우 L3까지 갔다가 돌아오게 된다. 즉, 메모리를 통해 전달되고 이더넷으로 나가지 않는다.

<br/>

# **4. L2: MAC, MAC 헤더**

IP 헤더는 늘 최종 목적지의 주소를 갖는다. 반면 L2는 기기와 기기 간의 연결이므로 MAC 주소는 현 목적지의 주소로 계속 변경된다. IP를 바탕으로 가야할 장치를 결정하는 L3 단계의 작업을 먼저 시행된 뒤 L2로 패킷을 넘기면 L2가 바로 다음 기기의 MAC 주소를 찾아내고, MAC 주소를 헤더에 붙이는 작업을 수행한다. 이렇게 만들어 진 전송 단위를 frame이라고 부른다.

IP 주소를 바탕으로 브로드캐스팅을 하여 MAC 주소를 알 수 있는데, 이를 ARP라고 한다. 브로드캐스트 MAC 주소인 255.255.255.255을 설정하여 ARP 요청을 한개 보내면 LAN 내 장치를 연결한 L2 장치가 이를 연결된 모든 장치에 전송한다. ARP 요청에 자기 IP인 것처럼 회신을 보내 해킹을 시도하기도 하는데 이를 ARP Scooping이라고 한다.

ARP는 한번 수행할 때마다 부하가 많이 걸리므로 최근의 기기들은 부팅 순간에 이 IP가 내 MAC이라는 의미로 ARP를 보낸다. 또, 한 LAN에 254개까지 세팅 가능하지만, 보통 부하를 줄이기 위해 더 적은 수로 세팅을 한다. arp -a로 현 컴퓨터에서 캐싱된 주소 목록을 확인할 수 있으며, 캐싱한 MAC 주소가 바뀐 상태로 전송을 시도하면 잘못 전송되기도 한다.

TCP 헤더는 L4, IP 헤더는 L3, MAC 헤더는 L2 각 계층에서 만들어진다. 그러나 다른 모든 계층은 자신이 만든 데이터로 헤더를 구성하는 반면 L2는 L3에서 받은 MAC 주소와 이더 타입을 바탕으로 헤더를 구성한다. 이런 이유로, 헤더 조합 자체는 L2에서 이루어지지만 몇몇 책에서는 L3 계층에서 MAC 헤더를 만든다고 표현하기도 한다. 

허브는 L2 스위치로, IP를 가지지 않으므로  L3에서는 이를 볼 수 없고, 그냥, MAC 주소를 바탕으로 L2 간의 데이터를 전송한다. 그러나 최근의 공유기는 대부분 한 기기 안에 L3 라우터와 L2 스위치 기능이 동시에 존재한다. 따라서 L2 스위치 기능을 위해 여러개의 포트를 갖고 있으며, 동시에 공유기의 L3 라우터 부분이 IP 주소 탐색 작업을 수행한다. 

스위치는 스위칭 가능한 기기라는 의미로 쓰이기 때문에 L2, L3, L4를 명시해주어야 한다. L3 라우터와 L3 스위치의 경우  사용하는 관점의 차이가 있을 뿐 기능 상 명확한 차이가 있는 것은 아니다. 과거에는 연결 역할만 되고 스위칭이 안되던 더미 스위치도 있었는데 최근에는 찾기 힘들다. 




