---
title: Procademy, Q2, 05) Network - ping, p2p, vpn, dns
categories: ProcademyReview
tags: 
toc: true
toc_sticky: true
---

이 포스트는 프로카데미 (게임 서버 아카데미) 수업을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. ICMP**

## **1) ICMP, Internet Control Message Protocol**

ICMP는 TCP/IP에서 네트워크 상 오류에 대한 컨트롤 메시지를 주고 받기 위해 사용하는 프로토콜이다. IP 데이터그램을 사용하지만 메시지는 TCP/IP 소프트웨어에 의해 처리된다. ICMP는 에러가 발생한 경우 IP 헤더에 기록된 출발지로 에러 정보를 보내며, 에러 메시지에는 크게 Destination Unreachable, Time Exceeded, Redirect 등이 있다. 

ICMP는 구체적으로 라우터가 고장났을 때, 네트워크 구획 내 라우터 정보를 갱신할 때, TTL이 0이 되어 폐기했을 때, IP 헤더에 문법 오류가 있어서 폐기했을 때 등의 상황에서 사용한다. ping, tracert가 ICMP를 활용한 대표적인 명령어이며, 국내 서버들 중엔 ICMP 수신을 차단한 곳도 있는데 이 경우 IP 주소 및 응답 속도 등을 확인할 수 없다. 

## **2) ping**

ping은 ICMP를 쓰는 대표 명령어로, 특정 주소가 요청을 받을 수 있지 진단하기 위해 사용한다. 이를 통해 간단한 네트워크 장애를 진단할 수 있으며, 응답 속도, IP 주소, 패킷 왕복 시간 등도 함께 얻을 수도 있다. ping은 L3에서 출발하지만 L3-L2-L1에서 걸리는 시간은 0에 가깝기 때문에 출력되는 시간은 L1과 L1 사이에 걸리는 시간만을 의미하며, 일반적으로 이를 네트워크 레이턴시라 부른다. 

ping도 엄밀하게는 RTT(Rount To Time)를 구하는 것이지만 일반적으로 RTT라고 하면 L7-L7간의 RTT, 즉 클라와 서버에서 소요된 시간까지 포함한다. 

## **3) tracert**

TTL 1부터 하나씩 늘려서 ping을 보냄으로써 목적지까지 IP를 가진 장치들의 경로를 보여준다. 패킷을 폐기할 경우 그에 대한 메시지를 ICMP로 응답 주게 되어있기 때문에 이를 이용한 것이다. ICMP 수신을 차단한 곳은 요청 시간이 만료되었다고 뜨며 아무런 정보도 돌아오지 않는다. 이유 없이 레이턴시가 길 때 어떤 회선에서 레이턴시가 생기는지 파악하기 위해 사용할 수 있다. 

간혹 사설 IP가 나오기도 하는데, 절대 최종 목적지가 되지 않고 경유지의 역할만 하는 라우터들이 연달아 붙어있는 경우에 공인 IP가 없어도 서로를 구분할 수 있으므로 사설 IP를 사용하기도 한다.

<br/>

# **2. p2p**

최근에는 dedicate 서버를 많이 사용하므로 MO에서도 Server-Client 구조를 일반적으로 사용하지만, 과거에는 방을 만든 방장의 컴퓨터가 Server 역할을 하는 p2p 구조가 많았다. 방장이 공인 IP를 사용한다면 해당 주소를 찾아가는데 문제가 되지 않지만, 공유기를 통해 연결되어 있고 포트포워딩이 안되어있다면 찾아갈 수가 없었다. 따라서 과거에는 공유기를 사용하는 PC는 방장을 할 수 없었다. 

이후에는 랑데뷰 서버를 통한 홀펀칭으로 이를 해결했다. 게임에 접속하면 유저들의 컴퓨터가 랑데뷰 서버에 포트포워딩 된 IP 주소를 전송하고, 그 주소로 다른 접속자들을 연결한다. 그러나 TCP에서는 주소를 알아도 연결이 안되면 메시지를 보낼 수 없기 때문에 홀펀칭은 UDP로만 구현할 수 있다. 그러나 이 경우에도 공유기가 자체적으로 패킷을 거른다면 해당 LAN의 PC는 방장이 될 수 없다.  

요즘은 릴레이 서버로 이를 해결한다. 메시지 연결용 서버가 있고, 모든 클라가 그 서버를 경유하여 통신하는 것이다. 네트워크는 서버-클라 구조지만 콘텐츠 로직 없이 메시지 연결만 하므로 콘텐츠적으로는 p2p라고 볼 수 있다. 프레임 상관 없이 메시지가 오는대로 처리하면 되기에 한 서버에 몇천명씩 붙어도 속도에 별 영향을 주지 않는다. 유지비는 조금 들지만 공유기를 많이 쓰는 국내 환경에 적합하다.

<br/>

# **3. vpn**

메시지를 경유하여 보내는 proxy와 달리 vpn은 타 LAN에 내 기기가 속한 것처럼 가상 이더넷을 만든다. vpn 서버의 공인 IP를 내 기기의 이더넷으로 설정하여 그 vpn 서버에서 사설 IP를 부여받은 것처럼 사용하는 것이다. 당연히 vpn 내부 LAN들과도 직접 통신할 수 있게 된다. 재택 근무 시 회사 LAN에 PC를 연결할 때도 이 방법을 사용한다. vpn gateway도 동일하게 NAT을 수행한다. 

vpn 서버 연결 자체가 부담이 크기 때문에 성능은 약간 떨어지며 동시 접속 가능한 세션 수도 그닥 많지는 않다. 또, vpn의 암호화는 현재 기술로 뚫기 어렵기 때문에 보안이 안좋은 국가에 갈 때는 국내 vpn에 연결하여 작업하는 경우도 많다. 가정용 iptime도 동시 사용자 5명 정도의 vpn 사용을 제공한다. 여기에 핸드폰을 등록해두면 밖에서도 집 와이파이를 사용하는 셈이 된다. 

<br/>

# **4. dns**

## **1) 도메인**
 
도메인, 도메인 네임이란 넓은 의미로는 네트워크 상에서 컴퓨터를 식별하는 호스트 명을 가리키며, 좁은 의미로는 도메인 레지스트리에게서 등록된 이름을 의미한다. 이를 이용해 IP 주소를 쓸 때보다 쉽게 사이트에 접근할 수 있으며, 여러 개의 IP 주소를 한 도메인에 대응시키거나 (서브 도메인) 여러 도메인을 하나의 IP 주소에 대응시킬 수도 있다. (가상 호스트)

![image](https://user-images.githubusercontent.com/96677719/231079558-00d30860-e14a-4fb0-ad9a-4319bbd0d0f6.png)

(이미지 출처: https://ko.wix.com/blog/post/what-is-a-domain)


## **2) DNS**

도메인 이름을 입력하면 해당 도메인 이름에 대응하는 IP를 찾기 위해 DNS, Domain Name System 서버에 요청을 보낸다. 따라서 도메인을 사면 내 서버의 IP를 직접 매핑하는 게 아니라 DNS에 도메인 이름과 IP를 올린다. 이때, 3개 이상의 DNS에 등록하는 걸 원칙으로 하며, 한 지역에 재해가 발생해도 다른 DNS를 쓸 수 있도록 공간적으로 멀리 있는 DNS를 사용해야 한다. 

사용자 측에서도 DNS 조회를 위한 DNS 서버가 필요한데 이는 보통 ISP 업체에서 제공한다. 내가 사용하는 서버에 naver.com을 조회했을 때 그 정보가 캐싱되어 있다면 이를 바로 반환받는다. 없을 경우 최상위 루트 도메인에서 .com을 찾고, .com에서 naver를 조회한다. 이때 최상위 루트 도메인 11개는 상수 값으로 정해져서 기기에 기본으로 저장되어 있다. 

캐싱된 주소는 TTL로 관리되는데, 이 시간이 길면 서버에 오는 부담이 적어지는 대신 변경 사항이 생겼을 때 빠르게 대응할 수 없다. Dynamic DNS도 있는데 이는 TTL을 몇십초 단위로 짧게 잡아서 유동 IP 상황에서도 즉각 대응할 수 있게끔 만든 DNS이다. 공유기에서 DDNS를 설정하면 IP가 바뀔 때마다 DNS 서버에 바뀐 IP를 계속 보내기 때문에 연결이 끊어지지 않는다. 

nslookup로 보면 DNS에서 IP 순서를 계속 바꾸어 반환한다. 소켓에서는 index 0에 접근하는 게 매크로로 있을 만큼 index 0를 많이 사용하는데, DNS에서 도메인 순서를 바꾸어주므로 그래도 분산이 된다. 반면 ping에서는 매번 동일한 IP 주소만 반환되는데, 이는 OS가 캐싱한 DNS에서 반환하기 때문이다. ipconfig/displaydns로 캐싱된 DNS를 볼 수 있으며, ipconfig/flushdns로 밀 수 있다. 