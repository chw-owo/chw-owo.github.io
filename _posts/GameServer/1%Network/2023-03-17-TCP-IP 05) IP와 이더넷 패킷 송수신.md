---
title: TCP-IP 05) IP와 이더넷 패킷 송수신
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 패킷의 기본**

TCP 담당 부분은 데이터를 패킷으로 만들고 IP 담당 부분은 의뢰를 받아 패킷을 상태에게 송신한다. 패킷은 헤더와 데이터로 구성되며, 헤더에는 수신처를 나타내는 주소 등의 제어정보가 포함된다. 보통 TCP 헤더와 데이터 조각이 패킷의 내용이 되며 이에 IP 헤더를 붙인 것이 IP의 패킷, IP 패킷에 이더넷 제어 정보가 담긴 MAC 헤더를 붙인 것이 이더넷의 패킷이 된다. 

패킷을 가장 가까운 중계 장치에 송신하면 중계 장치는 헤더의 수신처와 중계처에 등록된 정보를 결합해 패킷의 목적지를 정하고 다음 중계 장치로 전송한다. 이런 방식으로 중계를 이어가다보면 수신처에 도착하며, 수신처에서 송신처로 회답 패킷을 보낼 때도 동일하게 동작한다. 이처럼 송신처와 수신처를 구분할 필요가 없는 경우, 이들을 묶어 엔드노드라고 부른다. 

패킨 중계 장치에는 라우터와 허브가 있는데, 라우터는 목적지를 확인하여 다음 라우터를 나타내고 허브는 서브넷 안에서 패킷을 운반하여 다음 라우터에 보낸다. 라우터는 IP 규칙을, 허브는 이더넷 규칙을 따라서 패킷을 운반하기 때문에 다른 말로 표현하자면 라우터는 IP가 목적지를 확인하여 다음 IP 중계 장치를 나타내는 걸로, 허브는 서브넷 안에 있는 이더넷이 중계 장치까지 패킷을 운반하는 걸로 볼 수도 있다. 

TCP/IP 패킷에는 이더넷용 MAC 헤더와 IP용 IP 헤더가 붙어있다. 먼저 액세스 대상의 IP 주소를 IP 헤더 수신처에 기록하고, IP는 이 수신처가 어느 방향에 있는지 다음 라우터가 누구인지 조사하여 해당 라우터에 패킷이 도착하도록 이더넷에 의뢰한다. 이때 다음 라우터에 할당된 이더넷의 주소, MAC 주소를 조사하여 이를 MAC 헤더에 기록한다. 이런 방식으로 이더넷에게 어느 라우터에 가야 하는지 전달한다. 

이후 패킷은 이더넷 원리에 따라 움직이는 허브에 도착한다. 허브에는 목적지 판단을 위한 이더넷용 표가 있어서 이더넷 헤더의 수신처 정보와 표를 결합해 패킷을 목적지로 중계한다. 그러면 패킷은 다음 라우터에 도착하고 마찬가지로 라우터도 IP용 표를 바탕으로 패킷을 중계할 곳을 결정한다. 다음 라우터에 패킷을 건네기 위해 라우터 MAC 주소를 조사한 다음 이를 MAC 헤더에 기록, 패킷을 송신한다. 

위 흐름에서 IP와 이더넷이 역할을 분담하는 것을 볼 수 있는데, 이때 무선 LAN, ADSL, FTTH 등 IP 의뢰로 패킷을 운반할 수 있는 것이라면 뭐든 이더넷 대신 IP와 조합하여 적재적소에 사용할 수 있다. 거대한 네트워크 구축을 위해서는 이와 같은 유연성이 필요하기 때문에 역할을 분담하여 사용한다. 

<br/>

# **2. 패킷 송수신 동작 개요**

패킷 송수신의 출발점은 TCP 담당 부분이 IP 담당 부분에 패킷 송신을 의뢰하는 것에서 시작된다. TCP 담당 부분은 데이터 조각에 TCP 헤더를 부가하여 IP 담당 부분에 건네준다. IP 담당 부분은 IP 헤더와 MAC 헤더를 붙이는데 IP 헤더는 IP 주소 목적지 정보를 담고 있다. MAC 헤더는 이더넷 등의 LAN을 사용하여 가장 가까운 라우터까지 패킷을 운반할 때 사용하는 제어 정보를 담고 있다. 

이후 이렇게 만든 패킷을 이더넷, 무선 LAN과 같은 네트워크용 하드웨어에게 건네준다. 이때 패킷의 모습은 0이나 1의 bit가 이어진 디지털 데이터의 형태이며, 이것이 하드웨어에 의해 전기나 빛 신호 상태로 바뀌어 케이블에 송출된다. 헤더를 붙이고 송출하는 것까지가 IP 담당 부분의 역할이며 이후 패킷을 운반하는 것은 라우터, 허브와 같은 네트워크 기기의 역할이 된다. 

수신 동작은 역으로 LAN 어댑터가 신호를 디지털 데이터 모습으로 전환, 이를 IP 담당 부분에게 전달하는 순서로 이루어진다. 그러면 IP 담당 부분이 MAC 헤더, IP 헤더 뒤에 있는 TCP 헤더와 데이터 조각을 TCP 담당 부분에게 건넨다. 이때 IP 담당 부분은 TCP 헤더와 데이터의 내용을 보지 않고 한 덩어리의 바이너리 데이터로 간주한다. 내용물에 상관 없이 패킷으로 만들어 송수신할 뿐이다. 

<br/>

# **3. IP 헤더**

IP 헤더는 IP 프로토콜 버전, 헤더 길이, 서비스 유형, 전체 길이, 생존 기간, 프로토콜 번호, 송신처와 수신처의 IP 주소 등으로 이루어져있다. 수신처의 IP 주소는 애플리케이션에서 통지한 것을 그대로 사용하며, 송신처의 IP 주소는 컴퓨터에 할당된 IP 주소로 설정된다. 만약 복수의 LAN 어댑터를 장착하고 있다면 여러개의 IP 주소가 할당되므로 이 중 하나를 골라서 사용하게 된다. 패킷을 건네줄 상대를 판단하는 방법은 라우터가 IP용 표를 사용하여 다음 라우터를 결정하는 것과 동일하다. 이 IP용 표를 경로표라고 부른다. 

경로표로 경로를 찾을 때는 우선 Network Destination 항목과 비교하여 왼쪽 부분이 일치하는 것을 찾아낸다. 그 이후엔 LAN 어댑터와 같은 네트워크용 인터페이스를 나타내는 Interface 항목을 비교한다. 마지막으로 Gateway 항목에는 다음 라우터의 IP 주소를 기록하면 해당 목적지까지 패킷을 중계해준다. 경로표 맨 위 행에는 넷 마스크가 0.0.0.0으로 등록되어 있는데 이는 기본 게이트웨이를 나타내서 일치하는 것이 없다면 이걸로 간주한다. 또 프로토콜 번호라는 필드에도 값을 설정하는데, 이 값은 어디서 의뢰받았는지를 나타낸다. 예를 들어 TCP라면 0x06, UDP라면 0x17을 표기한다.

<br/>

# **4. MAC 헤더와 ARP**

MAC 헤더는 수신처, 송신처의 MAC 주소와 프로토콜 종료를 나타내는 Ether Type으로 구성되어 있다. IP주소는 그룹화 개념으로 사용되는 것과 달리 MAC 주소는 48bit가 하나의 단일한 값으로 사용된다. Ether Type은 IP 헤더의 프로토콜 번호와 비슷한데, IP 프로토콜을 나타내는 0800과 ARP 프로토콜을 나타내는 0806이 대표적으로 많이 사용된다. 송신처 MAC 주소에는 사용하려는 LAN 어댑터 내 ROM에 기록된 MAC 주소를 설정한다. 

수신처 MAC 주소는 다소 복잡한데, 경로표에서 일치하는 행의 Gateway에 기록된 IP 주소의 기기가 수신할 상대가 된다. 그리고 IP 주소에서 MAC 주소를 조사하는데 여기서 사용되는 게 ARP이다. 이더넷에서는 브로드캐스트로 연결된 전원에게 패킷을 전달할 수 있는데, 이를 이용해 해당 IP 주소를 가진 기기로부터 MAC 주소를 회답받는다. 이렇게 회답받은 MAC 주소를 MAC 헤더에 설정한다. 

패킷을 보낼 때마다 이 동작을 하면 ARP의 패킷이 불어나기 때문에 한번 조사한 결과는 ARP 캐시라는 메모리 영역에 보존하여 다시 이용한다. 패킷을 송신할 땐 우선 ARP 캐시를 조사하여 거기에 MAC 주소가 있을 경우 ARP를 조회하는 대신 그 값을 그대로 사용한다. 그러나 IP 주소가 달라지만 이 값도 달라지므로 시간이 지나면 ARP 캐시에 저장된 값도 삭제 된다. 

이와 같은 과정을 거쳐서 MAC 헤더를 IP 헤더 앞에 붙이는 것까지가 IP 담당 부분의 역할이다. 이후엔 완성된 패킷을 건네받은 LAN 어뎁터가 패킷을 송신하기만 하면 된다. 이러한 방법을 사용하면 IP 이외의 특수한 패킷도 한개의 LAN 어댑터로 대응할 수 있게 된다. 

<br/>

# **5. 이더넷의 기본**

![image](https://user-images.githubusercontent.com/96677719/225828347-8d3907a8-6d88-4f92-87a0-ce29fc6110c0.png)

이더넷은 다수의 컴퓨터가 여러 상대와 적은 비용으로 통신하기 위해 고안된 기술이다. 이더넷의 원형은 a와 같으며 이 경우 네트워크의 물리적 실체는 케이블과 케이블 사이에 신호를 흘리는 트랜시버 케이블만 존재했다. 이때는 신호를 보내면 연결된 전원에게 신호가 도착했으며, 수신처 주소를 확인하여 자신과 일치하면 수신하고 아니면 폐기하는 방식을 사용했다. b의 모습으로 변하면서 케이블은 리피터 허브로, 트랜시버 케이블은 트위스트 페어 케이블로 바뀌었으나 동작 방식은 원형과 동일했다. 

c와 같이 스위칭 허브를 사용한 형태가 보급되면서 현재의 이더넷이 생겨났다. 전원에게 신호가 전달되는 대신, 수신처 MAC 주소로만 신호가 흐르고 다른 부분엔 신호가 흐르지 않게 된 것이다. 그러나 수신처 MAC 주소 상대에게 패킷이 전달되는 점은 그대로이기에 MAC 헤더의 개념도 그대로 이어지게 되었다. 이더넷에 접속된 기기는 이더넷이라는 하나의 사양에 기초하여 동작하며 IP와 마찬가지로 패킷의 내용물에 상관 없이 일관되게 송수신 동작을 수행한다. 

<br/>

# **6. IP 패킷의 송신**





<br/>

# **7. 패킷 제어용 데이터**

<br/>

# **8. 허브로 패킷 송신**

<br/>

# **9. 돌아온 패킷 수신**

<br/>

# **10. 응답 패킷을 TCP로 넘기기**