---
title: TCP-IP 02) 서버에 접속하기
categories: 1%Network
tags: 
toc: true
toc_sticky: true
---

이 포스트는 Tsutomu tone의 <성공과 실패를 결정하는 1%의 네트워크 원리(성안당)> 내용을 바탕으로 공부한 내용을 정리한 것입니다. 

# **1. 접속의 의미**

소켓을 만들고 connect를 호출하면 프로토콜 스택은 자기쪽의 스택을 서버측 소켓에 접속시킨다. 이는 물리적 접속을 의미하는 것이 아니라 통신 상대와 제어 정보를 주고 받아 필요한 정보를 기록하고, 송수신 가능한 상태로 만드는 것을 의미한다. socket을 호출하여 소켓을 만드는 것만으로는 프로토콜 스택에 아무것도 전달되지 않으며, IP 주소와 포트 번호를 알려야 하는데 접속 동작이 이러한 역할을 한다. 

앞서 통로를 연결한다고 표현했던 것은, 클라이언트에서 자신의 IP 주소와 포트번호를 전달하며 서버에 데이터 송수신 의사를 보냈을 때, 서버 측에서 그 정보를 저장하여 송수신 할 수 있도록 하는 것을 의미한다. 이렇게 클라이언트에서 서버 측에 통신 동작 개시를 전달하는 것도 접속 동작의 역할 중 하나이다. 이후 송수신을 실행할 때 데이터를 일시적으로 저장하는 버퍼 메모리를 확보하는 것도 접속 동작에서 진행한다. 

<br/>

# **2. 제어 정보 헤더 배치**

제어 정보에는 크게 두 종류가 있는데 그 중 하나는 클라이언트와 서버가 서로 연락을 절충하기 위해 주고 받는 제어 정보이고 또 하나는 소켓에 기록하여 프로토콜 스택의 동작을 제어하기 위한 제어 정보이다. 

전자는 접속-송수신-해제 등에 필요한 정보로 포트번호, 시퀀스 번호, ACK 번호, 데이터 오프셋, 컨트롤 비트, 윈도우 사이즈 등을 포함하며 TCP 프로토콜 사양으로도 규정되어 있다. 이는 고정되어 있기 때문에 접속-송수신-해제의 각 단계에서 패킷 헤더에 이 정보를 부가하여 사용한다. 접속 단계에서는 데이터 없이 제어 정보 헤더로만 이루어진 패킷을 주고 받는다. 이때 프로토콜 스택 동작을 추적하며 헤더 각 항목의 의미가 수시로 변할 수 있다.

후자의 제어 정보는 애플리케이션에서 통지된 정보, 통신 상대로부터 받은 정보, 송수신 진행 상황 등이 수시로 기록되며, 프로토콜 스택은 차례로 정보를 참조하며 움직인다. 어떤 정보를 기록하는지는 OS에 따라 달라지지만 서로 달라도 통신에 문제가 되진 않는다. 소켓에 기록한 제어 정보는 상대측에서 볼 수 없으나 모든 OS가 공통으로 가질 법한 중요한 정보의 경우 명령으로 표시할 수 있다. 

<br/>

# **3. 접속 동작의 실제**

connect를 호출하면 IP, 포트 번호가 프로토콜 스택의 TCP 담당 부분에 전달된다. 그럼 송수신 동작 개시를 나타내는 제어 정보를 기록할 TCP 헤더를 만든다. 우선 TCP 헤더의 송신처, 수신처 소켓을 지정하고, 컨트롤 비트인 SYN 비트를 1로 바꾸어 지정했음을 표시한 후 이 외에 시퀀스 번호, 윈도우도 적절한 값으로 설정한다. 그리고 IP 담당 부분에 해당 TCP 헤더를 전달하여 송신을 의뢰하면 IP 담당 부분이 패킷 송신 동작을 실행한다.

패킷이 서버에 도착하면 서버 측 IP 담당 부분이 이것을 받아 TCP 담당 부분에 건네주고, 이 곳에서 헤더를 조사하여 기록된 소켓을 찾는다. 해당 소켓을 찾으면 필요한 정보를 기록하고, 접속 동작이 진행 중 상태를 갖게 된다. 이 과정이 끝나면 서버의 TCP 담당 부분이 응답을 돌려보내는데 이때 클라와 마찬가지로 TCP 헤더를 만들며, 헤더의 ACK 컨트롤 비트를 1로 만들어서 패킷을 받았음을 알린다. 그리고 마찬가지로 TCP 헤더를 전달하여 IP 담당 부분이 송신을 의뢰한다.

패킷이 클라이언트에 돌아오면 TCP 헤더를 조사하는데 이때 SYN이 1이면 접속 성공이므로 소켓에 접속 완료 제어 정보를 기록한다. 그리고 패킷이 도착한 것을 서버에 알리기 위해 ACK 비트를 1로 만든 TCP 헤더를 반송한다. 이것이 서버에 도착하면 접속 동작의 대화가 끝난다. 이렇게 커넥션이 이루어지면 프로토콜 스택의 접속 동작이 끝나므로 connect 실행이 끝나면서 애플리케이션을 제어할 수 있게 된다. 
